<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nautilus.CIM - –†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- Joint.js library for diagram editor -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.1/joint.min.css"
    />
    <!-- jQuery –¥–æ–ª–∂–µ–Ω –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–µ—Ä–≤—ã–º -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/backbone.js/1.4.0/backbone-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jointjs/3.7.1/joint.min.js"></script>
    <style>
      body,
      html {
        height: 100vh;
        margin: 0;
        overflow: hidden;
        line-height: 1.5;
      }

      .app-container {
        height: 100vh;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .main-content {
        flex: 1;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .toolbar {
        flex-shrink: 0;
      }

      .editor-content-area {
        flex: 1;
        display: flex;
        flex-direction: column;
        padding: 5px 20px;
        overflow: hidden;
      }

      .editor-container {
        flex: 1;
        display: flex;
        gap: 10px;
        overflow: hidden;
      }

      .editor-panel {
        /* flex: 1; */
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: white;
        width: 350px;
      }

      .editor-panel-header {
        padding: 5px 15px;
        background: #f5f5f5;
        border-bottom: 1px solid #ddd;
        font-weight: 600;
      }

      .editor-panel-content {
        flex: 1;
        overflow-y: auto;
        overflow-x: auto;
        padding: 5px 15px;
      }

      #available-tree,
      #profile-tree {
        min-width: min-content;
      }

      .editor-panel-actions {
        padding: 5px 15px;
        border-top: 1px solid #ddd;
        background: #f9f9f9;
      }

      /* Details panel */
      .details-panel {
        flex: 1;
        display: flex;
        flex-direction: column;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        min-width: 0; /* allow flex container to shrink properly */
      }
      .details-panel-content {
        flex: 1;
        padding: 5px 15px;
        overflow-y: auto;
        overflow-x: auto;
      }

      /* Tabs styling */
      .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 1px solid #e5e5e5;
        margin-bottom: 8px;
      }
      .tab {
        padding: 6px 10px;
        font-size: 13px;
        color: #444;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
      }
      .tab.active {
        background: #f5f5f5;
        border-color: #e5e5e5;
        color: #000;
        font-weight: 600;
      }
      .tab-content {
        display: none;
      }
      .tab-content.active {
        display: block;
      }

      .transfer-options {
        margin-bottom: 15px;
      }

      .transfer-options h4 {
        margin: 0 0 10px 0;
        font-size: 14px;
      }

      .option-checkbox {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
      }

      .option-checkbox input[type="checkbox"] {
        margin-right: 8px;
      }

      .option-checkbox label {
        font-size: 13px;
        cursor: pointer;
      }

      .tree-item-with-checkbox {
        display: flex;
        align-items: center;
        padding: 3px 0;
        white-space: nowrap;
      }

      .tree-item-checkbox {
        margin-right: 8px;
        cursor: pointer;
      }

      .tree-item-label {
        cursor: pointer;
        user-select: none;
        font-size: 13px;
        white-space: nowrap;
      }

      .tree-indent {
        display: inline-block;
        width: 20px;
      }

      .tree-toggle {
        display: inline-block;
        width: 16px;
        cursor: pointer;
        user-select: none;
        font-size: 12px;
        margin-right: 4px;
      }

      .tree-children {
        display: block;
      }

      .tree-children.collapsed {
        display: none;
      }

      .tree-item-with-checkbox.tree-item-selected {
        background-color: #e3f2fd;
      }

      .tree-item-with-checkbox:hover {
        background-color: #f5f5f5;
      }

      .tree-item-with-checkbox.tree-item-selected:hover {
        background-color: #d1e7fd;
      }

      /* Editor Mode Styles */
      .editor-content-area.standart-mode #diagram-editor {
        display: none;
      }

      .editor-content-area.standart-mode #editor-mode-details-panel {
        display: none;
      }

      .editor-content-area.editor-mode .details-panel {
        display: none;
      }

      .editor-content-area.editor-mode .editor-wrapper {
        height: 66.666%;
      }

      .editor-content-area.editor-mode #editor-mode-details-panel {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
        height: 33.333%;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #fff;
        overflow: auto;
        padding: 15px;
        margin-top: 10px;
      }

      .editor-content-area.editor-mode #diagram-editor {
        display: block;
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 4px;
        background: #f9f9f9;
        overflow: hidden;
        position: relative;
      }

      #diagram-editor .diagram-canvas {
        width: 100%;
        height: 100%;
        background: #ffffff;
        background-image: linear-gradient(
            0deg,
            transparent 24%,
            rgba(0, 0, 0, 0.05) 25%,
            rgba(0, 0, 0, 0.05) 26%,
            transparent 27%,
            transparent 74%,
            rgba(0, 0, 0, 0.05) 75%,
            rgba(0, 0, 0, 0.05) 76%,
            transparent 77%,
            transparent
          ),
          linear-gradient(
            90deg,
            transparent 24%,
            rgba(0, 0, 0, 0.05) 25%,
            rgba(0, 0, 0, 0.05) 26%,
            transparent 27%,
            transparent 74%,
            rgba(0, 0, 0, 0.05) 75%,
            rgba(0, 0, 0, 0.05) 76%,
            transparent 77%,
            transparent
          );
        background-size: 20px 20px;
      }

      .diagram-toolbar {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
        background: white;
        padding: 8px;
        border-radius: 4px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        display: flex;
        gap: 8px;
      }

      .diagram-tool-btn {
        padding: 6px 12px;
        border: 1px solid #ddd;
        background: white;
        border-radius: 3px;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .diagram-tool-btn:hover {
        background: #f5f5f5;
        border-color: #4a90e2;
      }

      .diagram-tool-btn.active {
        background: #4a90e2;
        color: white;
        border-color: #4a90e2;
      }

      .tree-item-label {
        cursor: grab;
      }

      .tree-item-label.dragging {
        opacity: 0.5;
        cursor: grabbing;
      }

      #diagram-editor.drag-over {
        background: #e3f2fd;
      }

      /* Editor mode details panel tabs */
      #editor-mode-details-panel .tabs {
        display: flex;
        gap: 8px;
        border-bottom: 1px solid #e5e5e5;
        margin-bottom: 12px;
      }

      #editor-mode-details-panel .tab {
        padding: 6px 12px;
        font-size: 13px;
        color: #444;
        cursor: pointer;
        border: 1px solid transparent;
        border-bottom: none;
        border-top-left-radius: 4px;
        border-top-right-radius: 4px;
        background: transparent;
      }

      #editor-mode-details-panel .tab.active {
        background: #f5f5f5;
        border-color: #e5e5e5;
        color: #000;
        font-weight: 600;
      }

      #editor-mode-details-panel .tab-content {
        display: none;
      }

      #editor-mode-details-panel .tab-content.active {
        display: block;
      }

      .attribute-item, .link-item {
        display: flex;
        align-items: flex-start;
        padding: 8px;
        margin-bottom: 6px;
        border: 1px solid #e5e5e5;
        border-radius: 4px;
        background: #fafafa;
      }

      .attribute-item:hover, .link-item:hover {
        background: #f0f0f0;
      }

      .attribute-checkbox, .link-checkbox {
        margin-right: 10px;
        margin-top: 2px;
      }

      .attribute-details, .link-details {
        flex: 1;
      }

      .attribute-name, .link-name {
        font-weight: 600;
        color: #333;
        margin-bottom: 3px;
      }

      .attribute-type, .link-type {
        color: #666;
        font-size: 12px;
        margin-bottom: 3px;
      }

      .attribute-description, .link-description {
        color: #888;
        font-size: 12px;
        font-style: italic;
      }

      /* Table-like layout for attributes */
      .attributes-table {
        /* border: 1px solid #ddd; */
        /* border-radius: 4px; */
        overflow: hidden;
        margin-top: 10px;
      }

      .attributes-table-header {
        display: grid;
        grid-template-columns: 40px 1fr 1fr 100px 2fr;
        background: transparent;
        border-bottom: 1px solid #ddd;
        font-weight: 600;
        font-size: 13px;
      }

      .attributes-table-header > div {
        padding: 6px 10px;
      }

      .attributes-table-row {
        display: grid;
        grid-template-columns: 40px 1fr 1fr 100px 2fr;
        border-bottom: 1px solid #e5e5e5;
        background: #fff;
        align-items: start;
      }

      .attributes-table-row:hover {
        background: #f9f9f9;
      }

      .attributes-table-row:last-child {
        border-bottom: none;
      }

      .attributes-table-cell {
        padding: 6px 10px;
        font-size: 13px;
        word-wrap: break-word;
      }

      .attributes-table-cell-checkbox {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 6px 10px;
      }

      .attributes-table-empty {
        padding: 20px;
        text-align: center;
        color: #888;
        font-style: italic;
        border-top: 1px solid #e5e5e5;
      }

      .search-box {
        margin-bottom: 10px;
      }

      .search-input {
        width: 100%;
        padding: 8px 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-size: 14px;
      }

      .search-input:focus {
        outline: none;
        border-color: #4a90e2;
      }

      .btn-group {
        display: flex;
        gap: 10px;
      }

      .profile-name-display {
        font-size: 18px;
        font-weight: 600;
        color: #666;
        padding-left: 20px;

        /* margin-top: 5px; */
      }
#editor-mode-profile-object {
  padding-left: 10px;
   border-left: 1px solid #ddd;
}

.attributes-table-row.already-in-profile {
  background-color: #e8f5e9 !important;
}

.attributes-table-row.already-in-profile:hover {
  background-color: #c8e6c9 !important;
}

.attributes-table-row.already-in-profile input[type="checkbox"] {
  cursor: not-allowed;
}


    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- MAIN CONTENT -->
      <div class="main-content">
        <div class="toolbar">
          <div class="toolbar-title">
            <span id="page-title">–†–µ–¥–∞–∫—Ç–æ—Ä –ø—Ä–æ—Ñ–∏–ª—è</span>
            <span class="profile-name-display" id="profile-name-display"
              >–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span
            >
          </div>
          <div class="toolbar-actions">
            <button
              class="btn btn-secondary"
              id="toggle-mode-btn"
              onclick="setEditorMode()"
            >
              üìê –†–µ–∂–∏–º –¥–∏–∞–≥—Ä–∞–º–º—ã
            </button>
            <button
              class="btn btn-secondary"
              onclick="window.location.href='project-details.html'"
            >
              ‚Üê –ù–∞–∑–∞–¥
            </button>
            <button class="btn btn-primary" onclick="saveProfile()">
              üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
          </div>
        </div>

        <div class="editor-content-area standart-mode">
          <div class="editor-wrapper editor-content-area">
            <div class="editor-container">
              <!-- LEFT PANEL: Available Models and Profiles -->
              <div class="editor-panel">
                <div class="editor-panel-header">–ú–æ–¥–µ–ª–∏ –∏ –ø—Ä–æ—Ñ–∏–ª–∏ –ø—Ä–æ–µ–∫—Ç–∞</div>
                <div class="editor-panel-content">
                  <div class="search-box">
                    <input
                      type="text"
                      class="search-input"
                      placeholder="–ü–æ–∏—Å–∫..."
                      id="left-search"
                      oninput="filterLeftTree()"
                    />
                  </div>
                  <div id="available-tree">
                    <!-- Tree will be rendered here -->
                  </div>
                </div>
                <div class="editor-panel-actions">
                  <!-- <div class="transfer-options">
                                <h4>–û–ø—Ü–∏–∏ –ø–µ—Ä–µ–Ω–æ—Å–∞</h4>
                                <div class="option-checkbox">
                                    <input type="checkbox" id="option-selected-only" checked>
                                    <label for="option-selected-only">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ —Ç–æ–ª—å–∫–æ –≤—ã–¥–µ–ª–µ–Ω–Ω—ã–µ –æ–±—ä–µ–∫—Ç—ã</label>
                                </div>
                                <div class="option-checkbox">
                                    <input type="checkbox" id="option-include-attributes">
                                    <label for="option-include-attributes">–í–∫–ª—é—á–∏—Ç—å –∞—Ç—Ä–∏–±—É—Ç—ã</label>
                                </div>
                                <div class="option-checkbox">
                                    <input type="checkbox" id="option-include-links">
                                    <label for="option-include-links">–í–∫–ª—é—á–∏—Ç—å —Å–≤—è–∑–∏</label>
                                </div>
                                <div class="option-checkbox">
                                    <input type="checkbox" id="option-include-parents">
                                    <label for="option-include-parents">–í–∫–ª—é—á–∏—Ç—å –∫–ª–∞—Å—Å—ã - —Ä–æ–¥–∏—Ç–µ–ª–∏</label>
                                </div>
                                <div class="option-checkbox">
                                    <input type="checkbox" id="option-include-associations">
                                    <label for="option-include-associations">–í–∫–ª—é—á–∏—Ç—å –∫–ª–∞—Å—Å—ã, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —á–µ—Ä–µ–∑ –∞—Å—Å–æ—Ü–∏–∞—Ü–∏—é</label>
                                </div>
                            </div> -->
                  <button
                    class="btn btn-primary"
                    onclick="transferToProfile()"
                    style="width: 100%"
                  >
                    ‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
                  </button>

                  <button
                    class="btn btn-secondary"
                    onclick="transferToProfile()"
                    style="width: 100%"
                  >
                    ‚úï –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                  </button>
                </div>
              </div>

              <div id="diagram-editor" class="hidden"></div>

              <!-- RIGHT PANEL: Profile Being Edited -->
              <div class="editor-panel">
                <div class="editor-panel-header">
                  <span id="profile-header-name">–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</span>
                </div>
                <div class="editor-panel-content">
                  <div class="search-box">
                    <input
                      type="text"
                      class="search-input"
                      placeholder="–ü–æ–∏—Å–∫..."
                      id="right-search"
                      oninput="filterRightTree()"
                    />
                  </div>
                  <div id="profile-tree">
                    <div
                      class="text-center text-muted"
                      style="padding: 40px 20px"
                    >
                      –ü—Ä–æ—Ñ–∏–ª—å –ø—É—Å—Ç. –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ª–µ–≤–∞ –∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∏—Ö –≤
                      –ø—Ä–æ—Ñ–∏–ª—å.
                    </div>
                  </div>
                </div>
                <div class="editor-panel-actions">
                  <button
                    class="btn btn-primary"
                    onclick="removeFromProfile()"
                    style="width: 100%"
                  >
                    ‚úï –ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
                  </button>

                  <button
                    class="btn btn-secondary"
                    onclick="transferToProfile()"
                    style="width: 100%"
                  >
                    ‚úï –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                  </button>
                </div>
              </div>
              <div class="details-panel">
                <div class="details-panel-content">
                  <div class="tabs" id="details-tabs">
                    <div
                      class="tab active"
                      data-tab="model"
                      onclick="switchDetailsTab('model')"
                    >
                      –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ –º–æ–¥–µ–ª–∏
                    </div>
                    <div
                      class="tab"
                      data-tab="profile"
                      onclick="switchDetailsTab('profile')"
                    >
                      –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ –ø—Ä–æ—Ñ–∏–ª—è
                    </div>
                    <!-- <div class="tab" data-tab="misc" onclick="switchDetailsTab('misc')">—Ä–∞–∑–Ω–æ–µ</div> -->
                  </div>

                  <div class="tab-content active" data-tab-content="model">
                    <div class="text-muted" style="padding: 10px 0">
                      –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ –º–æ–¥–µ–ª–∏.
                    </div>
                  </div>

                  <div class="tab-content" data-tab-content="profile">
                    <div class="text-muted" style="padding: 10px 0">
                      –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–±—ä–µ–∫—Ç–µ –ø—Ä–æ—Ñ–∏–ª—è.
                    </div>
                  </div>

                  <!-- <div class="tab-content" data-tab-content="misc">
                    <div class="text-muted" style="padding: 10px 0">
                      –ü—Ä–æ—á–∏–µ —Å–≤–µ–¥–µ–Ω–∏—è –∏ —Å–ª—É–∂–µ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è.
                    </div>
                  </div> -->
                </div>
              </div>
            </div>
            <div id="editor-mode-details-panel" class="hidden">
              <div id="editor-mode-model-object">
                <div class="tabs" id="editor-details-tabs">
                  <div class="tab active" data-tab="object-info">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                  <div class="tab" data-tab="object-attributes">–ê—Ç—Ä–∏–±—É—Ç—ã</div>
                  <div class="tab" data-tab="object-links">–°–≤—è–∑–∏</div>
                </div>
                <div class="tab-content active">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–∏—Å–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞
                    –º–æ–¥–µ–ª–∏.
                  </div>
                </div>
                <div class="tab-content">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—Ç—Ç—Ä–∏–±—É—Ç–∞—Ö –æ–±—ä–µ–∫—Ç–∞
                    –º–æ–¥–µ–ª–∏.
                  </div>
                </div>
                <div class="tab-content">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–≤—è–∑—è—Ö –æ–±—ä–µ–∫—Ç–∞ –º–æ–¥–µ–ª–∏.
                  </div>
                </div>
              </div>
              
              <div id="editor-mode-profile-object">
                <div class="tabs" id="editor-details-tabs">
                  <div class="tab active" data-tab="object-info">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                  <div class="tab" data-tab="object-attributes">–ê—Ç—Ä–∏–±—É—Ç—ã</div>
                  <div class="tab" data-tab="object-links">–°–≤—è–∑–∏</div>
                </div>
                <div class="tab-content active">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–∏—Å–∞–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–∞
                    –ø—Ä–æ—Ñ–∏–ª—è.
                  </div>
                </div>
                <div class="tab-content">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∞—Ç—Ç—Ä–∏–±—É—Ç–∞—Ö –æ–±—ä–µ–∫—Ç–∞
                    –ø—Ä–æ—Ñ–∏–ª—è.
                  </div>
                </div>
                <div class="tab-content">
                  <div class="text-muted" style="padding: 10px 0">
                    –ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–≤—è–∑—è—Ö –æ–±—ä–µ–∫—Ç–∞
                    –ø—Ä–æ—Ñ–∏–ª—è.
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <script src="data.js"></script>
    <script>
      let profileData = {
        id: null,
        name: "–ù–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å",
        items: [],
      };

      let availableData = [];
      let selectedLeftItems = new Set();
      let selectedRightItems = new Set();
      let expandedLeftItems = new Set();
      let expandedRightItems = new Set();
      let activeLeftItem = null;
      let activeRightItem = null;

      document.addEventListener("DOMContentLoaded", async () => {
        await loadSampleData();
        loadProfileFromUrl();
        loadAvailableData();
        renderAvailableTree();
        renderProfileTree();
      });

      function loadProfileFromUrl() {
        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get("profileId");
        const projectId = getCurrentProjectId();

        if (profileId && projectId) {
          const profile = getProfile(projectId, parseInt(profileId));
          if (profile) {
            profileData.id = profile.id;
            profileData.name = profile.name;
            profileData.items = profile.rootPackages || [];

            document.getElementById("profile-name-display").textContent =
              profile.name;
            document.getElementById("profile-header-name").textContent =
              profile.name;
          }
        }
      }

      function loadAvailableData() {
        const projectId = getCurrentProjectId();
        if (!projectId) return;

        const project = getProject(projectId);
        if (!project) return;

        availableData = [];

        // Add models
        if (project.models) {
          project.models.forEach((model) => {
            availableData.push({
              type: "model",
              id: model.id,
              name: model.name,
              data: model,
              children: model.rootPackages || [],
            });
          });
        }

        // Add profiles
        if (project.profiles) {
          project.profiles.forEach((profile) => {
            // Don't include the profile being edited
            if (profile.id !== profileData.id) {
              availableData.push({
                type: "profile",
                id: profile.id,
                name: profile.name,
                data: profile,
                children: profile.rootPackages || [],
              });
            }
          });
        }
      }

      function renderAvailableTree() {
        const container = document.getElementById("available-tree");
        let html = "";

        availableData.forEach((item, index) => {
          const itemKey = `left-${item.type}-${item.id}`;
          const isChecked = selectedLeftItems.has(itemKey);
          const isExpanded = expandedLeftItems.has(itemKey);
          const icon = item.type === "model" ? "üìã" : "‚öôÔ∏è";
          const hasChildren = item.children && item.children.length > 0;

          const isActive = activeLeftItem === itemKey;

          html += `
                    <div class="tree-item-with-checkbox ${
                      isActive ? "tree-item-selected" : ""
                    }" onclick="setActiveLeftItem('${itemKey}', event)">
                        <span class="tree-toggle" onclick="toggleLeftExpand('${itemKey}'); event.stopPropagation();">
                            ${hasChildren ? (isExpanded ? "‚ñº" : "‚ñ∂") : " "}
                        </span>
                        <input 
                            type="checkbox" 
                            class="tree-item-checkbox" 
                            id="${itemKey}"
                            ${isChecked ? "checked" : ""}
                            onchange="toggleLeftItem('${itemKey}'); event.stopPropagation();"
                            onclick="event.stopPropagation();"
                        >
                        <span class="tree-item-label" draggable="true" ondragstart="handleDragStart(event, '${itemKey}')">
                            ${icon} ${item.name} (${
            item.type === "model" ? "Model" : "Profile"
          })
                        </span>
                    </div>
                `;

          // Render children (packages)
          if (hasChildren) {
            html += `<div class="tree-children ${
              isExpanded ? "" : "collapsed"
            }" id="children-${itemKey}">`;
            html += renderTreeChildren(item.children, 1, "left", itemKey);
            html += `</div>`;
          }
        });

        container.innerHTML =
          html || '<div class="text-center text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>';
      }

      function renderTreeChildren(items, level, side, parentKey) {
        let html = "";

        items.forEach((item, index) => {
          const itemKey = `${parentKey}-pkg-${index}`;
          const isChecked =
            side === "left"
              ? selectedLeftItems.has(itemKey)
              : selectedRightItems.has(itemKey);
          const isExpanded =
            side === "left"
              ? expandedLeftItems.has(itemKey)
              : expandedRightItems.has(itemKey);

          const hasChildren =
            (item.elements && item.elements.length > 0) ||
            (item.children && item.children.length > 0);

          const isActive =
            side === "left"
              ? activeLeftItem === itemKey
              : activeRightItem === itemKey;

          // const indent = '<span class="tree-indent"></span>'.repeat(level);

          html += `
                    <div class="tree-item-with-checkbox ${
                      isActive ? "tree-item-selected" : ""
                    }" onclick="${
            side === "left" ? "setActiveLeftItem" : "setActiveRightItem"
          }('${itemKey}', event)">
                        <span class="tree-toggle" onclick="${
                          side === "left"
                            ? "toggleLeftExpand"
                            : "toggleRightExpand"
                        }('${itemKey}'); event.stopPropagation();">
                            ${hasChildren ? (isExpanded ? "‚ñº" : "‚ñ∂") : " "}
                        </span>
                        <input 
                            type="checkbox" 
                            class="tree-item-checkbox" 
                            id="${itemKey}"
                            ${isChecked ? "checked" : ""}
                            onchange="${
                              side === "left"
                                ? "toggleLeftItem"
                                : "toggleRightItem"
                            }('${itemKey}'); event.stopPropagation();"
                            onclick="event.stopPropagation();"
                        >
                        <span class="tree-item-label" draggable="true" ondragstart="handleDragStart(event, '${itemKey}')">
                            üì¶ ${item.name || "Package"}
                        </span>
                    </div>
                `;

          // Render children container
          if (hasChildren) {
            html += `<div class="tree-children ${
              isExpanded ? "" : "collapsed"
            }" id="children-${itemKey}">`;

            // Render elements
            if (item.elements && item.elements.length > 0) {
              item.elements.forEach((elem, elemIndex) => {
                const elemKey = `${itemKey}-elem-${elemIndex}`;
                const elemChecked =
                  side === "left"
                    ? selectedLeftItems.has(elemKey)
                    : selectedRightItems.has(elemKey);
                const elemActive =
                  side === "left"
                    ? activeLeftItem === elemKey
                    : activeRightItem === elemKey;
                // const elemIndent = '<span class="tree-indent"></span>'.repeat(level + 1);

                html += `
                                <div class="tree-item-with-checkbox ${
                                  elemActive ? "tree-item-selected" : ""
                                }" onclick="${
                  side === "left" ? "setActiveLeftItem" : "setActiveRightItem"
                }('${elemKey}', event)">
                                    <span class="tree-toggle"> </span>
                                    <input 
                                        type="checkbox" 
                                        class="tree-item-checkbox" 
                                        id="${elemKey}"
                                        ${elemChecked ? "checked" : ""}
                                        onchange="${
                                          side === "left"
                                            ? "toggleLeftItem"
                                            : "toggleRightItem"
                                        }('${elemKey}'); event.stopPropagation();"
                                        onclick="event.stopPropagation();"
                                    >
                                    <span class="tree-item-label" draggable="true" ondragstart="handleDragStart(event, '${elemKey}')">
                                        üìÑ ${elem.name || "Class"}
                                    </span>
                                </div>
                            `;
              });
            }

            // Render child packages
            if (item.children && item.children.length > 0) {
              html += renderTreeChildren(
                item.children,
                level + 1,
                side,
                itemKey
              );
            }

            html += `</div>`;
          }
        });

        return html;
      }

      function renderProfileTree() {
        const container = document.getElementById("profile-tree");

        if (!profileData.items || profileData.items.length === 0) {
          container.innerHTML = `
                    <div class="text-center text-muted" style="padding: 40px 20px;">
                        –ü—Ä–æ—Ñ–∏–ª—å –ø—É—Å—Ç. –í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã —Å–ª–µ–≤–∞ –∏ –ø–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –∏—Ö –≤ –ø—Ä–æ—Ñ–∏–ª—å.
                    </div>
                `;
          return;
        }

        let html = renderTreeChildren(profileData.items, 0, "right", "profile");
        container.innerHTML = html;
      }

      function toggleLeftItem(itemKey) {
        const checkbox = document.getElementById(itemKey);
        if (checkbox.checked) {
          selectedLeftItems.add(itemKey);
        } else {
          selectedLeftItems.delete(itemKey);
        }
      }

      function toggleRightItem(itemKey) {
        const checkbox = document.getElementById(itemKey);
        if (checkbox.checked) {
          selectedRightItems.add(itemKey);
        } else {
          selectedRightItems.delete(itemKey);
        }
      }

      function toggleLeftExpand(itemKey) {
        if (expandedLeftItems.has(itemKey)) {
          expandedLeftItems.delete(itemKey);
        } else {
          expandedLeftItems.add(itemKey);
        }
        renderAvailableTree();
      }

      function toggleRightExpand(itemKey) {
        if (expandedRightItems.has(itemKey)) {
          expandedRightItems.delete(itemKey);
        } else {
          expandedRightItems.add(itemKey);
        }
        renderProfileTree();
      }

      function syncLeftTreeWithRightItem(rightItemKey) {
        const rightInfo = resolveRightKey(rightItemKey);
        if (!rightInfo || !rightInfo.data) return;

        // Find corresponding item in left tree
        const matchingLeftKey = findMatchingLeftItem(rightInfo);
        
        if (matchingLeftKey) {
          // Expand all parent items
          expandPathToLeftItem(matchingLeftKey);
          
          // Set as active
          activeLeftItem = matchingLeftKey;
          
          // Re-render trees
          renderAvailableTree();
          
          // Update model panel
          renderEditorModeDetailsPanel();
        } else {
          // Object not found in left tree - clear active item
          activeLeftItem = null;
          renderAvailableTree();
          
          // Show "not found" message in left panel
          const modelObjectPanel = document.getElementById('editor-mode-model-object');
          if (modelObjectPanel) {
            const data = rightInfo.data;
            const isElement = rightInfo.kind === 'element';
            const attrs = isElement ? (data.attributes || []) : [];
            const links = isElement ? (data.links || []).filter(l => {
              return !(l.relation_kind === 'Generalization' && l.role === 'parent');
            }) : [];
            
            let html = `
              <div class="tabs">
                <div class="tab active" onclick="switchEditorTab('description')">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                ${isElement ? `<div class="tab" onclick="switchEditorTab('attributes')">–ê—Ç—Ä–∏–±—É—Ç—ã</div>` : ''}
                ${isElement ? `<div class="tab" onclick="switchEditorTab('links')">–°–≤—è–∑–∏</div>` : ''}
              </div>

              <div class="tab-content active" data-tab="description">
                <p style="color: #888; font-style: italic; padding: 10px 0;">
                  –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö.
                </p>
              </div>
            `;

            if (isElement) {
              html += `
              <div class="tab-content" data-tab="attributes">
                <h4 style="margin-top: 0;">–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
                <p style="color: #888; font-style: italic;">
                  –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö.
                </p>
              </div>
              `;

              html += `
              <div class="tab-content" data-tab="links">
                <h4 style="margin-top: 0;">–°–≤—è–∑–∏</h4>
                <p style="color: #888; font-style: italic;">
                  –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –º–æ–¥–µ–ª—è—Ö.
                </p>
              </div>
              `;
            }

            modelObjectPanel.innerHTML = html;
          }
        }
      }

      function syncProfileTreeWithLeftItem(leftItemKey) {
        const leftInfo = resolveLeftKey(leftItemKey);
        if (!leftInfo || !leftInfo.data) return;

        // Find corresponding item in profile tree
        const matchingProfileKey = findMatchingProfileItem(leftInfo);
        
        if (matchingProfileKey) {
          // Expand all parent items
          expandPathToItem(matchingProfileKey);
          
          // Set as active
          activeRightItem = matchingProfileKey;
          
          // Re-render trees
          renderProfileTree();
          
          // Update profile panel
          renderEditorModeProfilePanel();
        } else {
          // Object not found in profile - clear active item
          activeRightItem = null;
          renderProfileTree();
          
          // Show "not in profile" message in right panel
          const profileObjectPanel = document.getElementById('editor-mode-profile-object');
          if (profileObjectPanel) {
            const data = leftInfo.data;
            const isElement = leftInfo.kind === 'element';
            const attrs = isElement ? (data.attributes || []) : [];
            const links = isElement ? (data.links || []).filter(l => {
              return !(l.relation_kind === 'Generalization' && l.role === 'parent');
            }) : [];
            
            let html = `
              <div class="tabs">
                <div class="tab active" onclick="switchProfileTab('description')">–û–ø–∏—Å–∞–Ω–∏–µ</div>
                ${isElement ? `<div class="tab" onclick="switchProfileTab('attributes')">–ê—Ç—Ä–∏–±—É—Ç—ã</div>` : ''}
                ${isElement ? `<div class="tab" onclick="switchProfileTab('links')">–°–≤—è–∑–∏</div>` : ''}
              </div>

              <div class="tab-content active" data-tab="description">
                <p style="color: #888; font-style: italic; padding: 10px 0;">
                  –î–∞–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–µ–∫—É—â–µ–º –ø—Ä–æ—Ñ–∏–ª–µ. 
                  –í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –µ–≥–æ, –∏—Å–ø–æ–ª—å–∑—É—è –∫–Ω–æ–ø–∫—É "‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å".
                </p>
              </div>
            `;

            if (isElement) {
              html += `
              <div class="tab-content" data-tab="attributes">
                <h4 style="margin-top: 0;">–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
                <p style="color: #888; font-style: italic;">
                  –û–±—ä–µ–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Ñ–∏–ª–µ. –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –æ–±—ä–µ–∫—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –µ–≥–æ –∞—Ç—Ä–∏–±—É—Ç–∞–º–∏.
                </p>
              </div>
              `;

              html += `
              <div class="tab-content" data-tab="links">
                <h4 style="margin-top: 0;">–°–≤—è–∑–∏</h4>
                <p style="color: #888; font-style: italic;">
                  –û–±—ä–µ–∫—Ç –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ—Ñ–∏–ª–µ. –ü–µ—Ä–µ–Ω–µ—Å–∏—Ç–µ –æ–±—ä–µ–∫—Ç –≤ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã —Ä–∞–±–æ—Ç–∞—Ç—å —Å –µ–≥–æ —Å–≤—è–∑—è–º–∏.
                </p>
              </div>
              `;
            }

            profileObjectPanel.innerHTML = html;
          }
        }
      }

      function findMatchingLeftItem(rightInfo) {
        const rightData = rightInfo.data;
        if (!rightData) return null;

        // Strategy 1: Match by model ID and object ID
        if (rightData.id) {
          const match1 = searchLeftTreeByModelAndObjectId(rightInfo.name, rightData.id);
          if (match1) return match1;
        }

        // Strategy 2: Match by object ID only
        if (rightData.id) {
          const match2 = searchLeftTreeByObjectId(rightData.id);
          if (match2) return match2;
        }

        // Strategy 3: Match by name
        if (rightData.name) {
          const match3 = searchLeftTreeByName(rightData.name, rightInfo.kind);
          if (match3) return match3;
        }

        return null;
      }

      function findMatchingProfileItem(leftInfo) {
        const leftData = leftInfo.data;
        if (!leftData) return null;

        // Strategy 1: Match by model ID and object ID
        if (leftData.id) {
          const match1 = searchProfileTreeByModelAndObjectId(leftInfo.name, leftData.id);
          if (match1) return match1;
        }

        // Strategy 2: Match by object ID only
        if (leftData.id) {
          const match2 = searchProfileTreeByObjectId(leftData.id);
          if (match2) return match2;
        }

        // Strategy 3: Match by name
        if (leftData.name) {
          const match3 = searchProfileTreeByName(leftData.name, leftInfo.kind);
          if (match3) return match3;
        }

        return null;
      }

      function searchLeftTreeByModelAndObjectId(modelName, objectId) {
        // Search in availableData (models and profiles)
        for (let i = 0; i < availableData.length; i++) {
          const baseEntry = availableData[i];
          const baseKey = `left-${baseEntry.type}-${baseEntry.id}`;
          
          // Check if this is the matching model/profile
          if (baseEntry.name === modelName || baseEntry.id === objectId) {
            // Search within this model/profile
            const result = searchInLeftItems(baseEntry.children || [], baseKey, (item) => {
              return item.id === objectId;
            });
            if (result) return result;
          }
        }
        return null;
      }

      function searchLeftTreeByObjectId(objectId) {
        // Search in all availableData
        for (let i = 0; i < availableData.length; i++) {
          const baseEntry = availableData[i];
          const baseKey = `left-${baseEntry.type}-${baseEntry.id}`;
          
          const result = searchInLeftItems(baseEntry.children || [], baseKey, (item) => {
            return item.id === objectId;
          });
          if (result) return result;
        }
        return null;
      }

      function searchLeftTreeByName(name, kind) {
        // Search in all availableData
        for (let i = 0; i < availableData.length; i++) {
          const baseEntry = availableData[i];
          const baseKey = `left-${baseEntry.type}-${baseEntry.id}`;
          
          const result = searchInLeftItems(baseEntry.children || [], baseKey, (item) => {
            return item.name === name;
          });
          if (result) return result;
        }
        return null;
      }

      function searchInLeftItems(items, parentKey, matcher) {
        if (!items || !Array.isArray(items)) return null;

        for (let pkgIdx = 0; pkgIdx < items.length; pkgIdx++) {
          const pkg = items[pkgIdx];
          const pkgKey = `${parentKey}-pkg-${pkgIdx}`;

          // Check if this package matches
          if (matcher(pkg)) {
            return pkgKey;
          }

          // Check elements in this package
          if (pkg.elements && Array.isArray(pkg.elements)) {
            for (let elemIdx = 0; elemIdx < pkg.elements.length; elemIdx++) {
              const elem = pkg.elements[elemIdx];
              const elemKey = `${pkgKey}-elem-${elemIdx}`;

              if (matcher(elem)) {
                return elemKey;
              }
            }
          }

          // Recursively search in child packages
          if (pkg.children && Array.isArray(pkg.children)) {
            const childMatch = searchInLeftItems(pkg.children, pkgKey, matcher);
            if (childMatch) return childMatch;
          }
        }

        return null;
      }

      function expandPathToLeftItem(itemKey) {
        // Parse the path and expand all parent items
        const parts = itemKey.split('-');
        
        // First part should be like 'left-model-123' or 'left-profile-456'
        let currentPath = '';
        let i = 0;
        
        // Build base path (left-{type}-{id})
        while (i < parts.length && parts[i] !== 'pkg' && parts[i] !== 'elem') {
          if (currentPath) currentPath += '-';
          currentPath += parts[i];
          i++;
        }
        
        // Expand base item
        expandedLeftItems.add(currentPath);
        
        // Now expand packages
        for (; i < parts.length; i++) {
          if (parts[i] === 'pkg' && i + 1 < parts.length) {
            currentPath += `-pkg-${parts[i + 1]}`;
            expandedLeftItems.add(currentPath);
            i++; // Skip the index part
          } else if (parts[i] === 'elem') {
            // Don't need to expand elements
            break;
          }
        }
      }

      function searchProfileTreeByModelAndObjectId(modelName, objectId) {
        return searchInProfileItems(profileData.items, 'profile', (item) => {
          return item.id === objectId;
        });
      }

      function searchProfileTreeByObjectId(objectId) {
        return searchInProfileItems(profileData.items, 'profile', (item) => {
          return item.id === objectId;
        });
      }

      function searchProfileTreeByName(name, kind) {
        return searchInProfileItems(profileData.items, 'profile', (item) => {
          return item.name === name;
        });
      }

      function searchInProfileItems(items, parentKey, matcher) {
        if (!items || !Array.isArray(items)) return null;

        for (let pkgIdx = 0; pkgIdx < items.length; pkgIdx++) {
          const pkg = items[pkgIdx];
          const pkgKey = `${parentKey}-pkg-${pkgIdx}`;

          // Check if this package matches
          if (matcher(pkg)) {
            return pkgKey;
          }

          // Check elements in this package
          if (pkg.elements && Array.isArray(pkg.elements)) {
            for (let elemIdx = 0; elemIdx < pkg.elements.length; elemIdx++) {
              const elem = pkg.elements[elemIdx];
              const elemKey = `${pkgKey}-elem-${elemIdx}`;

              if (matcher(elem)) {
                return elemKey;
              }
            }
          }

          // Recursively search in child packages
          if (pkg.children && Array.isArray(pkg.children)) {
            const childMatch = searchInProfileItems(pkg.children, pkgKey, matcher);
            if (childMatch) return childMatch;
          }
        }

        return null;
      }

      function expandPathToItem(itemKey) {
        // Parse the path and expand all parent items
        const parts = itemKey.split('-');
        let currentPath = 'profile';

        for (let i = 0; i < parts.length; i++) {
          if (parts[i] === 'pkg' && i + 1 < parts.length) {
            currentPath += `-pkg-${parts[i + 1]}`;
            expandedRightItems.add(currentPath);
            i++; // Skip the index part
          } else if (parts[i] === 'elem') {
            // Don't need to expand elements
            break;
          }
        }
      }

      function setActiveLeftItem(itemKey, event) {
        if (event) event.stopPropagation();
        activeLeftItem = itemKey;
        renderAvailableTree();
        updateDetailsPanel("left");
        
        // Update editor mode details panel if in editor mode
        const contentArea = document.querySelector('.editor-content-area');
        if (contentArea && contentArea.classList.contains('editor-mode')) {
          // Synchronize with profile tree FIRST
          syncProfileTreeWithLeftItem(itemKey);
          
          // Then render editor mode details panel (after activeRightItem is set)
          renderEditorModeDetailsPanel();
        }
      }

      function setActiveRightItem(itemKey, event) {
        if (event) event.stopPropagation();
        activeRightItem = itemKey;
        renderProfileTree();
        updateDetailsPanel("right");
        
        // Update editor mode profile panel if in editor mode
        const contentArea = document.querySelector('.editor-content-area');
        if (contentArea && contentArea.classList.contains('editor-mode')) {
          // Synchronize with left tree FIRST
          syncLeftTreeWithRightItem(itemKey);
          
          // Then render editor mode profile panel (after activeLeftItem is set)
          renderEditorModeProfilePanel();
        }
      }

      function transferToProfile() {
        if (selectedLeftItems.size === 0) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞");
          return;
        }

        let transferredCount = 0;

        selectedLeftItems.forEach((itemKey) => {
          const info = resolveLeftKey(itemKey);
          if (!info || !info.data) return;

          // Parse the path to understand package hierarchy
          const pathInfo = parseItemPath(itemKey, info);

          // Transfer the item
          if (transferItem(pathInfo, info)) {
            transferredCount++;
          }
        });

        if (transferredCount > 0) {
          // Save to MemoryStore
          saveProfileToMemoryStore();

          // Clear selections
          selectedLeftItems.clear();

          // Re-render both trees
          renderAvailableTree();
          renderProfileTree();

          alert(`–£—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${transferredCount}`);
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ —ç–ª–µ–º–µ–Ω—Ç—ã");
        }
      }

      function parseItemPath(itemKey, info) {
        // Extract package path from itemKey
        // itemKey format: left-{type}-{id}[-pkg-{idx}]*[-elem-{idx}]
        const baseEntry = availableData.find((e) =>
          itemKey.startsWith(`left-${e.type}-${e.id}`)
        );
        if (!baseEntry) return null;

        const baseKey = `left-${baseEntry.type}-${baseEntry.id}`;
        const tail = itemKey.slice(baseKey.length);

        const packagePath = [];
        let currentPackages = baseEntry.children || [];

        if (tail) {
          const tokens = tail.split("-").filter(Boolean);
          for (let i = 0; i < tokens.length; i += 2) {
            const t = tokens[i];
            const idx = parseInt(tokens[i + 1], 10);

            if (t === "pkg") {
              const pkg = currentPackages[idx];
              if (pkg) {
                packagePath.push({
                  name: pkg.name,
                  type: pkg.type,
                  originalData: pkg,
                });
                currentPackages = pkg.children || [];
              }
            } else if (t === "elem") {
              // Element is inside the last package
              break;
            }
          }
        }

        return {
          packagePath,
          itemKind: info.kind,
          itemData: info.data,
        };
      }

      function transferItem(pathInfo, info) {
        if (!pathInfo) return false;

        // Deep copy the item data
        const copiedData = deepCopy(info.data);

        // Navigate/create package structure in profile
        let targetPackages = profileData.items;

        for (const pkgInfo of pathInfo.packagePath) {
          // Find or create package at this level
          let existingPkg = targetPackages.find(
            (p) => p.name === pkgInfo.name && p.type === pkgInfo.type
          );

          if (!existingPkg) {
            // Create new package
            existingPkg = {
              id: generateId(),
              name: pkgInfo.name,
              type: pkgInfo.type,
              description: pkgInfo.originalData.description || "",
              description_ru: pkgInfo.originalData.description_ru || "",
              children: [],
              elements: [],
            };
            targetPackages.push(existingPkg);
          }

          // Navigate deeper
          if (info.kind === "element") {
            // If transferring an element, it goes into elements array
            targetPackages = existingPkg.elements;
          } else {
            // If transferring a package, it goes into children
            targetPackages = existingPkg.children;
          }
        }

        // Add the copied item to target location
        if (info.kind === "package") {
          // Check if package already exists
          const exists = targetPackages.some(
            (p) => p.name === copiedData.name && p.type === copiedData.type
          );
          if (!exists) {
            copiedData.id = generateId();
            targetPackages.push(copiedData);
            return true;
          }
        } else if (info.kind === "element") {
          // Check if element already exists
          const exists = targetPackages.some(
            (e) => e.name === copiedData.name && e.type === copiedData.type
          );
          if (!exists) {
            copiedData.id = generateId();
            targetPackages.push(copiedData);
            return true;
          }
        }

        return false;
      }

      function deepCopy(obj) {
        if (obj === null || typeof obj !== "object") return obj;
        if (Array.isArray(obj)) return obj.map((item) => deepCopy(item));

        const copy = {};
        for (const key in obj) {
          if (obj.hasOwnProperty(key)) {
            copy[key] = deepCopy(obj[key]);
          }
        }
        return copy;
      }

      function generateId() {
        return Date.now() + Math.floor(Math.random() * 10000);
      }

      function saveProfileToMemoryStore() {
        const projectId = getCurrentProjectId();
        if (!projectId) return;

        const project = getProject(projectId);
        if (!project) return;

        // Find the profile in the project
        const profile = project.profiles.find((p) => p.id === profileData.id);
        if (profile) {
          // Update rootPackages with current profileData.items
          profile.rootPackages = profileData.items;
          console.log("‚úÖ Profile saved to MemoryStore:", profile.name);
        }
      }

      function removeFromProfile() {
        if (selectedRightItems.size === 0) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è");
          return;
        }

        let removedCount = 0;

        // Convert Set to Array and sort by depth (deepest first) to avoid index issues
        const sortedItems = Array.from(selectedRightItems).sort((a, b) => {
          const depthA = (a.match(/-/g) || []).length;
          const depthB = (b.match(/-/g) || []).length;
          return depthB - depthA; // Sort descending by depth
        });

        sortedItems.forEach((itemKey) => {
          if (removeItemFromProfile(itemKey)) {
            removedCount++;
          }
        });

        if (removedCount > 0) {
          // Save to MemoryStore
          saveProfileToMemoryStore();

          // Clear selections
          selectedRightItems.clear();
          activeRightItem = null;

          // Re-render profile tree
          renderProfileTree();

          // Clear details panel
          const profileContainer = document.querySelector(
            '.details-panel [data-tab-content="profile"]'
          );
          if (profileContainer) {
            profileContainer.innerHTML =
              '<div class="text-muted" style="padding: 10px 0;">–ó–¥–µ—Å—å –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏–∑ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è.</div>';
          }

          alert(`–£—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ —ç–ª–µ–º–µ–Ω—Ç–æ–≤: ${removedCount}`);
        } else {
          alert("–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å —ç–ª–µ–º–µ–Ω—Ç—ã");
        }
      }

      function removeItemFromProfile(itemKey) {
        // Parse itemKey to find the item location
        // itemKey format: profile[-pkg-{idx}]*[-elem-{idx}]
        const prefix = "profile";
        if (!itemKey.startsWith(prefix)) return false;

        const tail = itemKey.slice(prefix.length);
        if (!tail) return false; // Cannot remove root

        const tokens = tail.split("-").filter(Boolean);

        // Navigate to parent and get index to remove
        let currentContainer = profileData.items;
        let parentContainer = null;
        let indexToRemove = -1;
        let isElement = false;

        for (let i = 0; i < tokens.length; i += 2) {
          const t = tokens[i];
          const idx = parseInt(tokens[i + 1], 10);

          if (i === tokens.length - 2) {
            // Last token - this is what we want to remove
            indexToRemove = idx;
            parentContainer = currentContainer;
            isElement = t === "elem";
            break;
          } else {
            // Navigate deeper
            if (t === "pkg") {
              const pkg = currentContainer[idx];
              if (!pkg) return false;

              // Check if next token is 'elem' to switch to elements array
              if (i + 2 < tokens.length && tokens[i + 2] === "elem") {
                currentContainer = pkg.elements || [];
              } else {
                currentContainer = pkg.children || [];
              }
            }
          }
        }

        // Remove the item
        if (
          parentContainer &&
          indexToRemove >= 0 &&
          indexToRemove < parentContainer.length
        ) {
          parentContainer.splice(indexToRemove, 1);
          return true;
        }

        return false;
      }

      function saveProfile() {
        const projectId = getCurrentProjectId();
        if (!projectId) {
          alert("–ü—Ä–æ–µ–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω");
          return;
        }

        // Placeholder for save logic
        alert(
          `–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è "${profileData.name}"...\n\n–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ.`
        );

        // TODO: Implement actual save logic
        // This would involve:
        // 1. Validating profile data
        // 2. Saving to data structure
        // 3. Redirecting back to project-details.html
      }

      // Diagram editor globals
      let diagramGraph = null;
      let diagramPaper = null;
      let currentLinkMode = null; // 'generalization' or 'association'

      function setEditorMode() {
        const contentArea = document.querySelector(".editor-content-area");
        const toggleBtn = document.getElementById("toggle-mode-btn");

        if (contentArea.classList.contains("standart-mode")) {
          // Switch to editor mode
          contentArea.classList.remove("standart-mode");
          contentArea.classList.add("editor-mode");
          toggleBtn.textContent = "üìã –°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π —Ä–µ–∂–∏–º";

          // Initialize diagram editor
          initializeDiagramEditor();

          // Render details panel with tabs
          renderEditorModeDetailsPanel();
          renderEditorModeProfilePanel();
        } else {
          // Switch back to standard mode
          contentArea.classList.remove("editor-mode");
          contentArea.classList.add("standart-mode");
          toggleBtn.textContent = "üìê –†–µ–∂–∏–º –¥–∏–∞–≥—Ä–∞–º–º—ã";

          // Clean up diagram
          if (diagramPaper) {
            diagramPaper.remove();
            diagramPaper = null;
          }
          diagramGraph = null;
          currentLinkMode = null;
        }
      }

      function initializeDiagramEditor() {
        const container = document.getElementById("diagram-editor");

        // Create toolbar and canvas
        container.innerHTML = `
          <div class="diagram-toolbar">
            <button class="diagram-tool-btn" onclick="setLinkMode('generalization')" id="gen-btn" title="–°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –æ–±–æ–±—â–µ–Ω–∏—è">
              üî∫ –û–±–æ–±—â–µ–Ω–∏–µ
            </button>
            <button class="diagram-tool-btn" onclick="setLinkMode('association')" id="assoc-btn" title="–°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å –∞—Å—Å–æ—Ü–∏–∞—Ü–∏–∏">
              ‚û°Ô∏è –ê—Å—Å–æ—Ü–∏–∞—Ü–∏—è
            </button>
            <button class="diagram-tool-btn" onclick="clearLinkMode()" title="–û—Ç–º–µ–Ω–∏—Ç—å —Ä–µ–∂–∏–º —Å–≤—è–∑–∏">
              ‚ùå –û—Ç–º–µ–Ω–∞
            </button>
            <button class="diagram-tool-btn" onclick="clearDiagram()" title="–û—á–∏—Å—Ç–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É">
              üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
            </button>
          </div>
          <div class="diagram-canvas" id="diagram-canvas"></div>
        `;

        // Initialize JointJS
        const namespace = joint.shapes;
        diagramGraph = new joint.dia.Graph({}, { cellNamespace: namespace });

        diagramPaper = new joint.dia.Paper({
          el: document.getElementById("diagram-canvas"),
          model: diagramGraph,
          width: "100%",
          height: "100%",
          gridSize: 10,
          drawGrid: false,
          background: { color: "transparent" },
          cellViewNamespace: namespace,
          defaultLink: new joint.shapes.standard.Link(),
          linkPinning: false,
          interactive: { linkMove: false },
        });

        // Handle element click for both selection and link creation
        diagramPaper.on("element:pointerclick", function (elementView, evt) {
          if (currentLinkMode) {
            // Link creation mode
            if (!startLinkFrom) {
              // First click - select source element
              startLinkFrom = elementView.model;

              // Visual feedback - highlight selected element
              elementView.model.attr("body/strokeWidth", 4);
              elementView.model.attr("body/stroke", "#4a90e2");

              console.log(
                "–í—ã–±—Ä–∞–Ω –∏—Å—Ö–æ–¥–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç:",
                elementView.model.get("data").name
              );
            } else if (startLinkFrom !== elementView.model) {
              // Second click - create link to target element
              const sourceElement = startLinkFrom;
              createLink(sourceElement, elementView.model, currentLinkMode);

              // Reset visual feedback before clearing startLinkFrom
              sourceElement.attr("body/strokeWidth", 2);
              sourceElement.attr("body/stroke", "#333");

              startLinkFrom = null;
            } else {
              // Clicked same element - cancel
              startLinkFrom.attr("body/strokeWidth", 2);
              startLinkFrom.attr("body/stroke", "#333");
              startLinkFrom = null;
              console.log("–û—Ç–º–µ–Ω–µ–Ω–æ - –∫–ª–∏–∫–Ω—É–ª–∏ –Ω–∞ —Ç–æ—Ç –∂–µ —ç–ª–µ–º–µ–Ω—Ç");
            }
          } else {
            // Normal selection mode - show details
            showDiagramElementDetails(elementView.model);
          }
        });

        // Setup drag and drop
        setupDragAndDrop();
      }

      let startLinkFrom = null;

      function setLinkMode(mode) {
        currentLinkMode = mode;
        document.getElementById("gen-btn").classList.remove("active");
        document.getElementById("assoc-btn").classList.remove("active");

        if (mode === "generalization") {
          document.getElementById("gen-btn").classList.add("active");
        } else if (mode === "association") {
          document.getElementById("assoc-btn").classList.add("active");
        }
      }

      function clearLinkMode() {
        currentLinkMode = null;

        // Reset visual feedback if there was a selected element
        if (startLinkFrom) {
          startLinkFrom.attr("body/strokeWidth", 2);
          startLinkFrom.attr("body/stroke", "#333");
          startLinkFrom = null;
        }

        document.getElementById("gen-btn").classList.remove("active");
        document.getElementById("assoc-btn").classList.remove("active");
      }

      function createLink(source, target, linkType) {
        let link;

        if (linkType === "generalization") {
          // Generalization (inheritance) - triangle arrow
          link = new joint.shapes.standard.Link({
            source: { id: source.id },
            target: { id: target.id },
            attrs: {
              line: {
                stroke: "#333",
                strokeWidth: 2,
                targetMarker: {
                  type: "path",
                  d: "M 10 -5 0 0 10 5 Z",
                  fill: "white",
                  stroke: "#333",
                },
              },
            },
            labels: [
              {
                attrs: { text: { text: "‚óÅ Generalization" } },
              },
            ],
          });
        } else if (linkType === "association") {
          // Association - simple arrow
          link = new joint.shapes.standard.Link({
            source: { id: source.id },
            target: { id: target.id },
            attrs: {
              line: {
                stroke: "#333",
                strokeWidth: 2,
                targetMarker: {
                  type: "path",
                  d: "M 10 -5 0 0 10 5 z",
                },
              },
            },
            labels: [
              {
                attrs: { text: { text: "Association ‚û°" } },
              },
            ],
          });
        }

        link.addTo(diagramGraph);
        clearLinkMode();
      }

      function clearDiagram() {
        if (confirm("–û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é –¥–∏–∞–≥—Ä–∞–º–º—É?")) {
          diagramGraph.clear();
        }
      }

      function setupDragAndDrop() {
        const diagramEditor = document.getElementById("diagram-editor");

        // Prevent default drag behavior
        diagramEditor.addEventListener("dragover", function (e) {
          e.preventDefault();
          diagramEditor.classList.add("drag-over");
        });

        diagramEditor.addEventListener("dragleave", function (e) {
          diagramEditor.classList.remove("drag-over");
        });

        diagramEditor.addEventListener("drop", function (e) {
          e.preventDefault();
          diagramEditor.classList.remove("drag-over");

          const data = e.dataTransfer.getData("text/plain");
          if (!data) return;

          try {
            const itemInfo = JSON.parse(data);
            if (itemInfo.kind === "element" && itemInfo.data) {
              const canvas = document.getElementById("diagram-canvas");
              const rect = canvas.getBoundingClientRect();
              const x = e.clientX - rect.left;
              const y = e.clientY - rect.top;

              createClassElement(itemInfo.data, x, y);
            }
          } catch (err) {
            console.error("Drop error:", err);
          }
        });
      }

      function createClassElement(classData, x, y) {
        const attrs = classData.attributes || [];
        const links = classData.links || [];

        // Build attributes text
        const attrText =
          attrs.length > 0
            ? attrs
                .slice(0, 5)
                .map((a) => `+ ${a.name}: ${a.type || a.dataType || "any"}`)
                .join("\n")
            : "(–Ω–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤)";

        // Build methods/links text
        const linkText =
          links.length > 0
            ? links
                .slice(0, 3)
                .map((l) => `+ ${l.target_class_role_name || "link"}`)
                .join("\n")
            : "(–Ω–µ—Ç —Å–≤—è–∑–µ–π)";

        const classShape = new joint.shapes.standard.Rectangle({
          position: { x: x - 75, y: y - 50 },
          size: { width: 200, height: 120 },
          attrs: {
            body: {
              fill: "#ffffff",
              stroke: "#333",
              strokeWidth: 2,
              rx: 5,
              ry: 5,
            },
            label: {
              text: `¬´class¬ª\n${classData.name}\n${"‚Äî".repeat(
                15
              )}\n${attrText}`,
              fill: "#333",
              fontSize: 11,
              fontFamily: "monospace",
              textAnchor: "start",
              textVerticalAnchor: "top",
              refX: 5,
              refY: 5,
            },
          },
          data: classData, // Store original data
        });

        classShape.addTo(diagramGraph);
      }

      function showDiagramElementDetails(element) {
        const classData = element.get("data");
        if (!classData) return;

        const detailsPanel = document.getElementById(
          "editor-mode-details-panel"
        );
        const attrs = classData.attributes || [];
        const links = classData.links || [];

        let html = `
          <h4 style="margin-top: 0;">–ö–ª–∞—Å—Å: ${classData.name}</h4>
          <p><strong>–¢–∏–ø:</strong> ${classData.type || "Class"}</p>
          <p><strong>–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π:</strong> ${
            classData.isAbstract ? "–î–∞" : "–ù–µ—Ç"
          }</p>
          <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${
            classData.description || classData.description_ru || "–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è"
          }</p>
          
          <h5 style="margin-top: 15px; margin-bottom: 5px;">–ê—Ç—Ä–∏–±—É—Ç—ã (${
            attrs.length
          }):</h5>
        `;

        if (attrs.length > 0) {
          html += '<ul style="margin: 0; padding-left: 20px;">';
          attrs.forEach((a) => {
            html += `<li><strong>${a.name}</strong>: ${
              a.type || a.dataType || "any"
            } ${a.multiplicity ? `[${a.multiplicity}]` : ""}</li>`;
          });
          html += "</ul>";
        } else {
          html += '<p class="text-muted">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</p>';
        }

        html += `<h5 style="margin-top: 15px; margin-bottom: 5px;">–°–≤—è–∑–∏ (${links.length}):</h5>`;

        if (links.length > 0) {
          html += '<ul style="margin: 0; padding-left: 20px;">';
          links.forEach((l) => {
            html += `<li><strong>${
              l.target_class_role_name || "link"
            }</strong> ‚Üí ${l.target_class_name} (${l.relation_kind})</li>`;
          });
          html += "</ul>";
        } else {
          html += '<p class="text-muted">–ù–µ—Ç —Å–≤—è–∑–µ–π</p>';
        }

        detailsPanel.innerHTML = html;
      }

      // Editor mode details panel state
      let selectedAttributes = new Set();
      let selectedLinks = new Set();
      let selectedProfileAttributes = new Set();
      let selectedProfileLinks = new Set();

      // Helper function to check if a link exists in profile
      function linkExistsInProfile(modelLink, profileLinks) {
        if (!profileLinks || !Array.isArray(profileLinks)) return false;
        
        return profileLinks.some(profileLink => {
          const roleMatch = (modelLink.target_class_role_name || '') === (profileLink.target_class_role_name || '');
          const kindMatch = (modelLink.relation_kind || '') === (profileLink.relation_kind || '');
          const classMatch = (modelLink.target_class_name || '') === (profileLink.target_class_name || '');
          
          return roleMatch && kindMatch && classMatch;
        });
      }

      // Helper function to check if an attribute exists in profile
      function attributeExistsInProfile(modelAttr, profileAttrs) {
        if (!profileAttrs || !Array.isArray(profileAttrs)) return false;
        
        return profileAttrs.some(profileAttr => {
          const nameMatch = (modelAttr.name || '') === (profileAttr.name || '');
          const typeMatch = (modelAttr.type || modelAttr.dataType || '') === (profileAttr.type || profileAttr.dataType || '');
          
          return nameMatch && typeMatch;
        });
      }

      function renderEditorModeDetailsPanel() {
        const modelObjectPanel = document.getElementById('editor-mode-model-object');
        if (!modelObjectPanel) return;

        if (!activeLeftItem) {
          modelObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">–û–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏</h4>
            <div class="text-muted" style="padding: 10px 0;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –≤ –¥–µ—Ä–µ–≤–µ –º–æ–¥–µ–ª–µ–π –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</div>
          `;
          return;
        }

        const info = resolveLeftKey(activeLeftItem);
        if (!info || !info.data) {
          modelObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">–û–±—ä–µ–∫—Ç –º–æ–¥–µ–ª–∏</h4>
            <div class="text-muted" style="padding: 10px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
          `;
          return;
        }

        const data = info.data;
        const isElement = info.kind === 'element';

        if (!isElement) {
          modelObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">${info.kind === 'package' ? '–ü–∞–∫–µ—Ç' : info.kind === 'model' ? '–ú–æ–¥–µ–ª—å' : '–û–±—ä–µ–∫—Ç'}: ${esc(data.name)}</h4>
            <p style="padding: 10px 0;">${esc(data.description || data.description_ru || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
          `;
          return;
        }

        // Check if object exists in profile
        const objectExistsInProfile = activeRightItem !== null;

        // Render tabs for element (class)
        const attrs = data.attributes || [];
        const links = data.links || [];
        
        // Filter out parent Generalization links
        const filteredLinks = links.filter(l => {
          return !(l.relation_kind === 'Generalization' && l.role === 'parent');
        });

        let html = `
          <div class="tabs">
            <div class="tab active" onclick="switchEditorTab('description')">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="tab" onclick="switchEditorTab('attributes')">–ê—Ç—Ä–∏–±—É—Ç—ã (${attrs.length})</div>
            <div class="tab" onclick="switchEditorTab('links')">–°–≤—è–∑–∏ (${filteredLinks.length})</div>
          </div>

          <div class="tab-content active" data-tab="description">
            <h4 style="margin-top: 0;">–ö–ª–∞—Å—Å: ${esc(data.name)}</h4>
            <p><strong>–¢–∏–ø:</strong> ${esc(data.type || 'Class')}</p>
            <p><strong>–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π:</strong> ${data.isAbstract ? '–î–∞' : '–ù–µ—Ç'}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${esc(data.description || data.description_ru || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
            ${!objectExistsInProfile ? `
            <button class="btn btn-primary" onclick="transferToProfile()" style="margin-top: 10px; width: 100%;">
              ‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            ` : ''}
          </div>

          <div class="tab-content" data-tab="attributes">
            <h4 style="margin-top: 0;">–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
            <div class="attributes-table">
              <div class="attributes-table-header">
                <div></div>
                <div>–ò–º—è</div>
                <div>–¢–∏–ø</div>
                <div>–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å</div>
                <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
              </div>
        `;

        // Get profile attributes if object exists in profile
        let profileAttrs = [];
        if (objectExistsInProfile && activeRightItem) {
          const profileInfo = resolveRightKey(activeRightItem);
          if (profileInfo && profileInfo.data) {
            profileAttrs = profileInfo.data.attributes || [];
          }
        }

        if (attrs.length > 0) {
          attrs.forEach((attr, idx) => {
            const attrKey = `${activeLeftItem}-attr-${idx}`;
            const isChecked = selectedAttributes.has(attrKey);
            const alreadyInProfile = attributeExistsInProfile(attr, profileAttrs);
            const rowClass = alreadyInProfile ? 'attributes-table-row already-in-profile' : 'attributes-table-row';
            const disabledAttr = alreadyInProfile ? 'disabled' : '';
            
            html += `
              <div class="${rowClass}">
                <div class="attributes-table-cell-checkbox">
                  <input type="checkbox" id="${attrKey}" ${isChecked ? 'checked' : ''} ${disabledAttr}
                    onchange="toggleAttributeSelection('${attrKey}')">
                </div>
                <div class="attributes-table-cell">${esc(attr.name)}</div>
                <div class="attributes-table-cell">${esc(attr.type || attr.dataType || '-')}</div>
                <div class="attributes-table-cell">${esc(attr.multiplicity || '-')}</div>
                <div class="attributes-table-cell">${esc(attr.description || attr.description_ru || '')}</div>
              </div>
            `;
          });
          html += `
            </div>
            ${objectExistsInProfile ? `
            <button class="btn btn-primary" onclick="transferSelectedAttributes()" style="margin-top: 10px; width: 100%;">
              ‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            ` : ''}
          `;
        } else {
          html += `
              <div class="attributes-table-empty">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</div>
            </div>
          `;
        }

        html += '</div><div class="tab-content" data-tab="links"><h4 style="margin-top: 0;">–°–≤—è–∑–∏</h4>';

        html += `
          <div class="attributes-table">
            <div class="attributes-table-header">
              <div></div>
              <div>–†–æ–ª—å</div>
              <div>–¢–∏–ø —Å–≤—è–∑–∏</div>
              <div>–ö–ª–∞—Å—Å</div>
              <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
            </div>
        `;

        // Get profile links if object exists in profile
        let profileLinks = [];
        if (objectExistsInProfile && activeRightItem) {
          const profileInfo = resolveRightKey(activeRightItem);
          if (profileInfo && profileInfo.data) {
            const allProfileLinks = profileInfo.data.links || [];
            // Filter out parent Generalization links from profile too
            profileLinks = allProfileLinks.filter(l => {
              return !(l.relation_kind === 'Generalization' && l.role === 'parent');
            });
          }
        }

        if (filteredLinks.length > 0) {
          filteredLinks.forEach((link, idx) => {
            const linkKey = `${activeLeftItem}-link-${idx}`;
            const isChecked = selectedLinks.has(linkKey);
            const alreadyInProfile = linkExistsInProfile(link, profileLinks);
            const rowClass = alreadyInProfile ? 'attributes-table-row already-in-profile' : 'attributes-table-row';
            const disabledAttr = alreadyInProfile ? 'disabled' : '';
            
            html += `
              <div class="${rowClass}">
                <div class="attributes-table-cell-checkbox">
                  <input type="checkbox" id="${linkKey}" ${isChecked ? 'checked' : ''} ${disabledAttr}
                    onchange="toggleLinkSelection('${linkKey}')">
                </div>
                <div class="attributes-table-cell">${esc(link.target_class_role_name || '-')}</div>
                <div class="attributes-table-cell">${esc(link.relation_kind || '-')}</div>
                <div class="attributes-table-cell">${esc(link.target_class_name || '-')}</div>
                <div class="attributes-table-cell">${esc(link.description || link.target_description || '')}</div>
              </div>
            `;
          });
          html += `
            </div>
            ${objectExistsInProfile ? `
            <button class="btn btn-primary" onclick="transferSelectedLinks()" style="margin-top: 10px; width: 100%;">
              ‚Üí –ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –≤ –ø—Ä–æ—Ñ–∏–ª—å
            </button>
            ` : ''}
          `;
        } else {
          html += `
              <div class="attributes-table-empty">–ù–µ—Ç —Å–≤—è–∑–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
          `;
        }
        html += '</div>';
        modelObjectPanel.innerHTML = html;
      }

      function renderEditorModeProfilePanel() {
        const profileObjectPanel = document.getElementById('editor-mode-profile-object');
        if (!profileObjectPanel) return;

        if (!activeRightItem) {
          profileObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">–û–±—ä–µ–∫—Ç –ø—Ä–æ—Ñ–∏–ª—è</h4>
            <div class="text-muted" style="padding: 10px 0;">–í—ã–±–µ—Ä–∏—Ç–µ –æ–±—ä–µ–∫—Ç –≤ –¥–µ—Ä–µ–≤–µ –ø—Ä–æ—Ñ–∏–ª—è –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π</div>
          `;
          return;
        }

        const info = resolveRightKey(activeRightItem);
        if (!info || !info.data) {
          profileObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">–û–±—ä–µ–∫—Ç –ø—Ä–æ—Ñ–∏–ª—è</h4>
            <div class="text-muted" style="padding: 10px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
          `;
          return;
        }

        const data = info.data;
        const isElement = info.kind === 'element';

        if (!isElement) {
          profileObjectPanel.innerHTML = `
            <h4 style="margin-top: 0;">${info.kind === 'package' ? '–ü–∞–∫–µ—Ç' : '–û–±—ä–µ–∫—Ç'}: ${esc(data.name)}</h4>
            <p style="padding: 10px 0;">${esc(data.description || data.description_ru || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
          `;
          return;
        }

        // Render tabs for element (class)
        const attrs = data.attributes || [];
        const links = data.links || [];
        
        // Filter out parent Generalization links
        const filteredLinks = links.filter(l => {
          return !(l.relation_kind === 'Generalization' && l.role === 'parent');
        });

        let html = `
          <div class="tabs">
            <div class="tab active" onclick="switchProfileTab('description')">–û–ø–∏—Å–∞–Ω–∏–µ</div>
            <div class="tab" onclick="switchProfileTab('attributes')">–ê—Ç—Ä–∏–±—É—Ç—ã (${attrs.length})</div>
            <div class="tab" onclick="switchProfileTab('links')">–°–≤—è–∑–∏ (${filteredLinks.length})</div>
          </div>

          <div class="tab-content active" data-tab="description">
            <h4 style="margin-top: 0;">–ö–ª–∞—Å—Å: ${esc(data.name)}</h4>
            <p><strong>–¢–∏–ø:</strong> ${esc(data.type || 'Class')}</p>
            <p><strong>–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π:</strong> ${data.isAbstract ? '–î–∞' : '–ù–µ—Ç'}</p>
            <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> ${esc(data.description || data.description_ru || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è')}</p>
          </div>

          <div class="tab-content" data-tab="attributes">
            <h4 style="margin-top: 0;">–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
            <div class="attributes-table">
              <div class="attributes-table-header">
                <div></div>
                <div>–ò–º—è</div>
                <div>–¢–∏–ø</div>
                <div>–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å</div>
                <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
              </div>
        `;

        if (attrs.length > 0) {
          attrs.forEach((attr, idx) => {
            const attrKey = `${activeRightItem}-attr-${idx}`;
            const isChecked = selectedProfileAttributes.has(attrKey);
            html += `
              <div class="attributes-table-row">
                <div class="attributes-table-cell-checkbox">
                  <input type="checkbox" id="${attrKey}" ${isChecked ? 'checked' : ''}
                    onchange="toggleProfileAttributeSelection('${attrKey}')">
                </div>
                <div class="attributes-table-cell">${esc(attr.name || '-')}</div>
                <div class="attributes-table-cell">${esc(attr.type || attr.dataType || '-')}</div>
                <div class="attributes-table-cell">${esc(attr.multiplicity || '')}</div>
                <div class="attributes-table-cell">${esc(attr.description || attr.details || '')}</div>
              </div>
            `;
          });
          html += `
            </div>
            <button class="btn btn-primary" onclick="excludeSelectedAttributes()" style="margin-top: 10px; width: 100%;">
              ‚úñ –ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            </button>
          `;
        } else {
          html += `
              <div class="attributes-table-empty">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</div>
            </div>
          `;
        }

        html += '</div><div class="tab-content" data-tab="links"><h4 style="margin-top: 0;">–°–≤—è–∑–∏</h4>';

        html += `
          <div class="attributes-table">
            <div class="attributes-table-header">
              <div></div>
              <div>–†–æ–ª—å</div>
              <div>–¢–∏–ø —Å–≤—è–∑–∏</div>
              <div>–ö–ª–∞—Å—Å</div>
              <div>–û–ø–∏—Å–∞–Ω–∏–µ</div>
            </div>
        `;

        if (filteredLinks.length > 0) {
          filteredLinks.forEach((link, idx) => {
            const linkKey = `${activeRightItem}-link-${idx}`;
            const isChecked = selectedProfileLinks.has(linkKey);
            html += `
              <div class="attributes-table-row">
                <div class="attributes-table-cell-checkbox">
                  <input type="checkbox" id="${linkKey}" ${isChecked ? 'checked' : ''}
                    onchange="toggleProfileLinkSelection('${linkKey}')">
                </div>
                <div class="attributes-table-cell">${esc(link.target_class_role_name || '-')}</div>
                <div class="attributes-table-cell">${esc(link.relation_kind || '-')}</div>
                <div class="attributes-table-cell">${esc(link.target_class_name || '-')}</div>
                <div class="attributes-table-cell">${esc(link.description || link.target_description || '')}</div>
              </div>
            `;
          });
          html += `
            </div>
            <button class="btn btn-primary" onclick="excludeSelectedLinks()" style="margin-top: 10px; width: 100%;">
              ‚úñ –ò—Å–∫–ª—é—á–∏—Ç—å –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
            </button>
          `;
        } else {
          html += `
              <div class="attributes-table-empty">–ù–µ—Ç —Å–≤—è–∑–µ–π –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</div>
            </div>
          `;
        }

        html += '</div>';
        profileObjectPanel.innerHTML = html;
      }

      function switchProfileTab(tabName) {
        const tabs = document.querySelectorAll('#editor-mode-profile-object .tab');
        const contents = document.querySelectorAll('#editor-mode-profile-object .tab-content');

        tabs.forEach(tab => {
          if (tab.getAttribute('onclick').includes(tabName)) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });

        contents.forEach(content => {
          if (content.getAttribute('data-tab') === tabName) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });
      }

      function toggleProfileAttributeSelection(attrKey) {
        const checkbox = document.getElementById(attrKey);
        if (checkbox && checkbox.checked) {
          selectedProfileAttributes.add(attrKey);
        } else {
          selectedProfileAttributes.delete(attrKey);
        }
      }

      function toggleProfileLinkSelection(linkKey) {
        const checkbox = document.getElementById(linkKey);
        if (checkbox && checkbox.checked) {
          selectedProfileLinks.add(linkKey);
        } else {
          selectedProfileLinks.delete(linkKey);
        }
      }

      function excludeSelectedAttributes() {
        if (selectedProfileAttributes.size === 0) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è');
          return;
        }

        // TODO: Implement attribute exclusion logic
        alert(`–í—ã–±—Ä–∞–Ω–æ –∞—Ç—Ä–∏–±—É—Ç–æ–≤ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è: ${selectedProfileAttributes.size}\n\n–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        
        // Clear selection after exclusion
        selectedProfileAttributes.clear();
        renderEditorModeProfilePanel();
      }

      function excludeSelectedLinks() {
        if (selectedProfileLinks.size === 0) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏ –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è');
          return;
        }

        // TODO: Implement link exclusion logic
        alert(`–í—ã–±—Ä–∞–Ω–æ —Å–≤—è–∑–µ–π –¥–ª—è –∏—Å–∫–ª—é—á–µ–Ω–∏—è: ${selectedProfileLinks.size}\n\n–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –∏—Å–∫–ª—é—á–µ–Ω–∏—è –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        
        // Clear selection after exclusion
        selectedProfileLinks.clear();
        renderEditorModeProfilePanel();
      }

      function switchEditorTab(tabName) {
        const tabs = document.querySelectorAll('#editor-mode-model-object .tab');
        const contents = document.querySelectorAll('#editor-mode-model-object .tab-content');

        tabs.forEach(tab => {
          if (tab.getAttribute('onclick').includes(tabName)) {
            tab.classList.add('active');
          } else {
            tab.classList.remove('active');
          }
        });

        contents.forEach(content => {
          if (content.getAttribute('data-tab') === tabName) {
            content.classList.add('active');
          } else {
            content.classList.remove('active');
          }
        });
      }

      function toggleAttributeSelection(attrKey) {
        const checkbox = document.getElementById(attrKey);
        if (checkbox && checkbox.checked) {
          selectedAttributes.add(attrKey);
        } else {
          selectedAttributes.delete(attrKey);
        }
      }

      function toggleLinkSelection(linkKey) {
        const checkbox = document.getElementById(linkKey);
        if (checkbox && checkbox.checked) {
          selectedLinks.add(linkKey);
        } else {
          selectedLinks.delete(linkKey);
        }
      }

      function transferSelectedAttributes() {
        if (selectedAttributes.size === 0) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ –∞—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞');
          return;
        }

        // TODO: Implement attribute transfer logic
        alert(`–í—ã–±—Ä–∞–Ω–æ –∞—Ç—Ä–∏–±—É—Ç–æ–≤: ${selectedAttributes.size}\n\n–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        
        // Clear selection after transfer
        selectedAttributes.clear();
        renderEditorModeDetailsPanel();
      }

      function transferSelectedLinks() {
        if (selectedLinks.size === 0) {
          alert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–≤—è–∑–∏ –¥–ª—è –ø–µ—Ä–µ–Ω–æ—Å–∞');
          return;
        }

        // TODO: Implement link transfer logic
        alert(`–í—ã–±—Ä–∞–Ω–æ —Å–≤—è–∑–µ–π: ${selectedLinks.size}\n\n–§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –ø–µ—Ä–µ–Ω–æ—Å–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ`);
        
        // Clear selection after transfer
        selectedLinks.clear();
        renderEditorModeDetailsPanel();
      }

      function handleDragStart(event, itemKey) {
        event.stopPropagation();

        // Determine if this is from left or right tree
        let info;
        if (itemKey.startsWith("left-")) {
          info = resolveLeftKey(itemKey);
        } else if (itemKey.startsWith("profile")) {
          info = resolveRightKey(itemKey);
        }

        if (info && info.kind === "element" && info.data) {
          // Only allow dragging class elements
          event.dataTransfer.setData("text/plain", JSON.stringify(info));
          event.dataTransfer.effectAllowed = "copy";
          event.target.classList.add("dragging");
        } else {
          event.preventDefault();
        }
      }

      function filterLeftTree() {
        // Placeholder for filter logic
        console.log("Filter left tree");
      }

      function filterRightTree() {
        // Placeholder for filter logic
        console.log("Filter right tree");
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –≤–∫–ª–∞–¥–æ–∫ –≤ –ø–∞–Ω–µ–ª–∏ –¥–µ—Ç–∞–ª–µ–π
      function switchDetailsTab(tabKey) {
        const tabsContainer = document.getElementById("details-tabs");
        if (!tabsContainer) return;

        const tabs = tabsContainer.querySelectorAll(".tab");
        const contents = document.querySelectorAll(
          ".details-panel .tab-content"
        );

        tabs.forEach((t) => {
          if (t.getAttribute("data-tab") === tabKey) t.classList.add("active");
          else t.classList.remove("active");
        });

        contents.forEach((c) => {
          if (c.getAttribute("data-tab-content") === tabKey)
            c.classList.add("active");
          else c.classList.remove("active");
        });
      }

      function updateDetailsPanel(side) {
        if (side === "left" && activeLeftItem) {
          const info = resolveLeftKey(activeLeftItem);
          const html = renderDetailsHtml(info);
          const container = document.querySelector(
            '.details-panel [data-tab-content="model"]'
          );
          if (container) container.innerHTML = html;
          switchDetailsTab("model");
        } else if (side === "right" && activeRightItem) {
          const info = resolveRightKey(activeRightItem);
          const html = renderDetailsHtml(info);
          const container = document.querySelector(
            '.details-panel [data-tab-content="profile"]'
          );
          if (container) container.innerHTML = html;
          switchDetailsTab("profile");
        }
      }

      // –≤—ã–±–∏—Ä–∞–µ—Ç —Å–≤–æ–π—Å—Ç–≤–∞ –æ–±—ä–µ–∫—Ç–∞ –ø–æ –∫–ª—é—á—É
      function resolveLeftKey(itemKey) {
        let baseEntry = null;
        for (const entry of availableData) {
          const baseKey = `left-${entry.type}-${entry.id}`;
          if (itemKey.startsWith(baseKey)) {
            baseEntry = { entry, baseKey };
            break;
          }
        }
        if (!baseEntry)
          return { kind: "unknown", data: null, source: "left", name: "" };

        const { entry, baseKey } = baseEntry;
        const tail = itemKey.slice(baseKey.length);
        if (!tail) {
          return {
            kind: entry.type,
            data: entry.data,
            source: "left",
            name: entry.name,
          };
        }
        const tokens = tail.split("-").filter(Boolean);
        let packages = entry.children || [];
        let elements = null;
        let current = null;
        let kind = null;
        for (let i = 0; i < tokens.length; i += 2) {
          const t = tokens[i];
          const idx = parseInt(tokens[i + 1], 10);
          if (t === "pkg") {
            current = packages && packages[idx];
            kind = "package";
            packages = (current && current.children) || [];
            elements = (current && current.elements) || [];
          } else if (t === "elem") {
            current = elements && elements[idx];
            kind = "element";
            elements = null;
          }
        }
        return { kind, data: current, source: "left", name: entry.name };
      }

      function resolveRightKey(itemKey) {
        const prefix = "profile";
        if (!itemKey.startsWith(prefix))
          return {
            kind: "unknown",
            data: null,
            source: "right",
            name: profileData.name,
          };
        const tail = itemKey.slice(prefix.length);
        const tokens = tail.split("-").filter(Boolean);
        let packages = profileData.items || [];
        let elements = null;
        let current = null;
        let kind = null;
        for (let i = 0; i < tokens.length; i += 2) {
          const t = tokens[i];
          const idx = parseInt(tokens[i + 1], 10);
          if (t === "pkg") {
            current = packages && packages[idx];
            kind = "package";
            packages = (current && current.children) || [];
            elements = (current && current.elements) || [];
          } else if (t === "elem") {
            current = elements && elements[idx];
            kind = "element";
            elements = null;
          }
        }
        return { kind, data: current, source: "right", name: profileData.name };
      }

      function esc(v) {
        if (v === undefined || v === null) return "";
        const d = document.createElement("div");
        d.textContent = String(v);
        return d.innerHTML;
      }

      function renderDetailsHtml(info) {
        if (!info || !info.data) {
          return '<div class="text-muted" style="padding:10px 0;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è.</div>';
        }
        const d = info.data;
        const typeLabel =
          info.kind === "element"
            ? "–ö–ª–∞—Å—Å"
            : info.kind === "package"
            ? "–ü–∞–∫–µ—Ç"
            : info.kind === "model"
            ? "–ú–æ–¥–µ–ª—å"
            : info.kind === "profile"
            ? "–ü—Ä–æ—Ñ–∏–ª—å"
            : "–û–±—ä–µ–∫—Ç";
        const header = `
          <div class="mb-10" style="font-weight:600;">${esc(typeLabel)}: ${esc(
          d.name || info.name || ""
        )}</div>
        `;

        if (info.kind === "model" || info.kind === "profile") {
          const metaRows = [
            // ['–ù–∞–∑–≤–∞–Ω–∏–µ', d.name],
            ["–û–ø–∏—Å–∞–Ω–∏–µ", d.description || d.description_ru || ""],
            ["–í–µ—Ä—Å–∏—è", d.version || ""],
          ];
          // ].filter(r => r[1] !== '' && r[1] !== undefined && r[1] !== null);
          return header + table(metaRows);
        }

        if (info.kind === "package") {
          const rows = [
            // ['–ù–∞–∑–≤–∞–Ω–∏–µ', d.name],
            // ['–¢–∏–ø', d.type || 'Package'],
            ["–û–ø–∏—Å–∞–Ω–∏–µ", d.description || d.description_ru || ""],
          ];
          // ].filter(r => r[1] !== '' && r[1] !== undefined && r[1] !== null)
          return header + table(rows);
        }

        if (info.kind === "element") {
          const attrs = Array.isArray(d.attributes) ? d.attributes : [];
          const links = Array.isArray(d.links) ? d.links : [];
          const basicRows = [
            // ['–ù–∞–∑–≤–∞–Ω–∏–µ', d.name],
            // ['–¢–∏–ø', d.type || 'Class'],
            ["–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π", d.isAbstract ? "–î–∞" : "–ù–µ—Ç"],
            ["–û–ø–∏—Å–∞–Ω–∏–µ", d.description || d.description_ru || ""],
          ];
          // ].filter(r => r[1] !== '' && r[1] !== undefined && r[1] !== null);

          let html = header + table(basicRows);

          if (attrs.length) {
            const rows = attrs.map((a) => [
              a.name || "-",
              a.type || a.dataType || "-",
              a.multiplicity || "",
              a.description || a.details || "",
            ]);
            html +=
              sectionTitle("–ê—Ç—Ä–∏–±—É—Ç—ã") +
              tableWithHead(["–ò–º—è", "–¢–∏–ø", "–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å", "–û–ø–∏—Å–∞–Ω–∏–µ"], rows);
          } else {
            html +=
              sectionTitle("–ê—Ç—Ä–∏–±—É—Ç—ã") +
              '<div class="text-muted">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</div>';
          }

          if (links.length) {
            const rows = links.map((l) => [
              l.target_class_role_name || "-",
              l.relation_kind || "-",
              l.target_class_name || "-",
              l.multiplicity || "",
              l.description || l.details || "",
            ]);
            html +=
              sectionTitle("–°–≤—è–∑–∏") +
              tableWithHead(
                ["–ò–º—è", "–í–∏–¥ —Å–≤—è–∑–∏", "–¶–µ–ª–µ–≤–æ–π –∫–ª–∞—Å—Å", "–ö—Ä–∞—Ç–Ω–æ—Å—Ç—å", "–û–ø–∏—Å–∞–Ω–∏–µ"],
                rows
              );
          } else {
            html +=
              sectionTitle("–°–≤—è–∑–∏") +
              '<div class="text-muted">–ù–µ—Ç —Å–≤—è–∑–µ–π</div>';
          }

          return html;
        }

        return header + '<div class="text-muted">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ç–∏–ø –æ–±—ä–µ–∫—Ç–∞</div>';
      }

      function sectionTitle(t) {
        return `<h4 style="margin:20px 0 6px 0;">${esc(t)}</h4>`;
      }

      function table(rows) {
        if (!rows || !rows.length) return "";
        const trs = rows
          .map(
            (r) =>
              `<tr><td style="font-weight:600; width:180px;">${esc(
                r[0]
              )}</td><td>${esc(r[1])}</td></tr>`
          )
          .join("");
        return `<table class="table" style="margin-top:6px;">${trs}</table>`;
      }

      function tableWithHead(head, rows) {
        const thead = `<tr>${head
          .map(
            (h) =>
              `<th style="text-align:left; padding:4px 6px;">${esc(h)}</th>`
          )
          .join("")}</tr>`;
        const tbody = rows
          .map(
            (r) =>
              `<tr>${r
                .map((c) => `<td style="padding:4px 6px;">${esc(c)}</td>`)
                .join("")}</tr>`
          )
          .join("");
        return `  <table class="table" style="margin-top:6px; border-collapse:collapse; width:100%;">${thead}${tbody}</table>`;
      }
    </script>
  </body>
</html>
