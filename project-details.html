<!DOCTYPE html>
<html lang="ru">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nautilus.CIM - –°–≤–µ–¥–µ–Ω–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ</title>
    <link rel="stylesheet" href="styles.css" />
    <style>
      .context-menu {
        position: fixed;
        background: white;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        z-index: 10000;
        min-width: 180px;
        display: none;
      }
      .context-menu.show {
        display: block;
      }
      .context-menu-item {
        padding: 8px 16px;
        cursor: pointer;
        font-size: 14px;
        color: #333;
        transition: background-color 0.2s;
      }
      .context-menu-item:hover {
        background-color: #f0f0f0;
      }
      .context-menu-item:active {
        background-color: #e0e0e0;
      }

      /* Diagram Mode Styles */
      .diagram-mode-content-on {
        display: flex;
        flex-direction: column;
        height: 100%;
      }

      /* Hide standard mode content when diagram mode is active */
      .content-area:has(.diagram-mode-content-on) #standard-mode-content {
        display: none;
      }

      #diagram-container {
        height: 66.666%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        overflow: hidden;
        margin-bottom: 15px;
      }

      #item-container-diagram {
        height: 33.333%;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        background: var(--bg-secondary);
        overflow: auto;
        padding: 15px;
      }
    </style>
  </head>
  <body>
    <div class="app-container">
      <!-- SIDEBAR -->
      <div class="sidebar" id="sidebar">
        <button
          class="sidebar-toggle sidebar-open"
          onclick="toggleSidebar()"
          aria-label="Toggle sidebar"
        >
          <span class="toggle-icon">‚ò∞</span>
        </button>
        <div class="sidebar-header">
          <span id="sidebar-project-title">Nautilus.CIM</span>
        </div>
        <div class="sidebar-nav">
          <!-- <a href="index.html" class="nav-item">üìä –ì–ª–∞–≤–Ω–∞—è</a> -->
          <a href="projects.html" class="nav-item">üìÅ –ü—Ä–æ–µ–∫—Ç—ã</a>

          <div class="nav-section-title">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞</div>
          <div id="current-project-structure" class="project-structure-nav">
            <div class="no-items text-muted">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</div>
          </div>

          <div class="nav-section-title">–î–µ–π—Å—Ç–≤–∏—è</div>
          <div class="nav-item" onclick="openModal('new-model-modal')">
            ‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç –º–æ–¥–µ–ª–∏
          </div>
          <a href="compare.html" class="nav-item">üîç –°—Ä–∞–≤–Ω–µ–Ω–∏–µ</a>
        </div>
      </div>
      <div class="sidebar-resize-handle" id="sidebar-resize-handle"></div>

      <!-- MAIN CONTENT -->
      <div class="main-content">
        <div class="toolbar">
          <div class="toolbar-title">
            <span id="project-title">Nautilus.CIM</span>
          </div>
          <div class="toolbar-actions">
            <button
              class="btn btn-secondary"
              onclick="openDiagram()"
              id="diagram-btn"
              class="hidden"
            >
              üìê –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤
            </button>
            <button
              class="btn btn-primary"
              onclick="openModal('new-model-modal')"
            >
              + –î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å
            </button>
            <button
              class="btn btn-primary"
              onclick="openModal('new-profile-modal')"
            >
              + –°–æ–∑–¥–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
            </button>
          </div>
        </div>

        <div class="content-area">
          <div id="no-project-warning" class="hidden">
            <div class="warning-title">
              <div class="model-icon-large">üìÅ</div>
              <h3>–ü—Ä–æ–µ–∫—Ç –Ω–µ –≤—ã–±—Ä–∞–Ω</h3>
              <p>–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –º–æ–¥–µ–ª–µ–π</p>
              <button
                class="btn btn-primary mt-15"
                onclick="window.location.href='projects.html'"
              >
                –ü–µ—Ä–µ–π—Ç–∏ –∫ –ø—Ä–æ–µ–∫—Ç–∞–º
              </button>
            </div>
          </div>

          <div id="standard-mode-content">
            <div id="models-container" class="hidden">
              <div class="split-view">
                <div class="split-left">
                  <h3 class="mb-15">–°–ø–∏—Å–æ–∫ –º–æ–¥–µ–ª–µ–π</h3>
                  <div id="models-list"></div>
                </div>
                <div class="split-right">
                  <div id="model-details">
                    <div class="text-center">
                      –í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div id="profiles-container" class="mt-30" class="hidden">
              <div class="divider mb-15"></div>
              <div class="split-view">
                <div class="split-left">
                  <h3 class="mb-15">–°–ø–∏—Å–æ–∫ –ø—Ä–æ—Ñ–∏–ª–µ–π</h3>
                  <div id="profiles-list"></div>
                </div>
                <div class="split-right">
                  <div id="profile-details">
                    <div class="text-center">
                      –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ—Ñ–∏–ª—å –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div id="item-container" class="hidden"></div>
          </div>

          <div id="diagram-mode-content" class="hidden">
            <div id="diagram-container"></div>
            <div class="divider mb-15"></div>
            <div id="item-container-diagram"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- MODAL: New Model -->
    <div id="new-model-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–î–æ–±–∞–≤–∏—Ç—å –º–æ–¥–µ–ª—å –≤ –ø—Ä–æ–µ–∫—Ç</div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏ *</label>
          <input
            type="text"
            id="model-name"
            class="form-input"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: TC57CIM, IEC61970"
          />
        </div>
        <div class="form-group">
          <label class="form-label">–¢–∏–ø –º–æ–¥–µ–ª–∏</label>
          <select id="model-type" class="form-select">
            <option>–ö–∞–Ω–æ–Ω–∏—á–µ—Å–∫–∞—è –º–æ–¥–µ–ª—å</option>
            <option>–†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏</option>
          </select>
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            id="model-desc"
            class="form-textarea"
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏"
          ></textarea>
        </div>

        <div class="modal-buttons">
          <button
            class="btn btn-secondary"
            onclick="closeModal('new-model-modal')"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button class="btn btn-primary" onclick="createModel()">
            –î–æ–±–∞–≤–∏—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- MODAL: New Profile -->
    <div id="new-profile-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ—Ñ–∏–ª—å</div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è *</label>
          <input
            type="text"
            id="profile-name"
            class="form-input"
            placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: GOST-58651.2"
          />
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            id="profile-desc"
            class="form-textarea"
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è"
          ></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">–í–µ—Ä—Å–∏—è</label>
          <input
            type="text"
            id="profile-version"
            class="form-input"
            value="1.0"
          />
        </div>
        <div class="modal-buttons">
          <button
            class="btn btn-secondary"
            onclick="closeModal('new-profile-modal')"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button class="btn btn-primary" onclick="createProfile()">
            –°–æ–∑–¥–∞—Ç—å
          </button>
        </div>
      </div>
    </div>

    <div id="new-project-modal" class="modal">
      <div class="modal-content">
        <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç</div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞ *</label>
          <input
            type="text"
            id="project-name"
            class="form-input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"
          />
        </div>
        <div class="form-group">
          <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
          <textarea
            id="project-desc"
            class="form-textarea"
            placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–µ–∫—Ç–∞"
          ></textarea>
        </div>
        <div class="form-group">
          <label class="form-label">–í–µ—Ä—Å–∏—è</label>
          <input
            type="text"
            id="project-version"
            class="form-input"
            value="1.0"
          />
        </div>
        <div class="modal-buttons">
          <button
            class="btn btn-secondary"
            onclick="closeModal('new-project-modal')"
          >
            –û—Ç–º–µ–Ω–∞
          </button>
          <button
            class="btn btn-primary"
            onclick="alert('–°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –≤ —Ä–∞–∑–¥–µ–ª–µ –ü—Ä–æ–µ–∫—Ç—ã')"
          >
            –°–æ–∑–¥–∞—Ç—å
          </button>
        </div>
      </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu" class="context-menu">
      <div
        class="context-menu-item"
        onclick="handleContextMenuAction('add-package')"
      >
        üì¶ –î–æ–±–∞–≤–∏—Ç—å –ø–∞–∫–µ—Ç
      </div>
      <div
        class="context-menu-item"
        onclick="handleContextMenuAction('add-class')"
      >
        üìÑ –î–æ–±–∞–≤–∏—Ç—å –∫–ª–∞—Å—Å
      </div>
      <div
        class="context-menu-item"
        onclick="handleContextMenuAction('add-diagram')"
      >
        üìê –î–æ–±–∞–≤–∏—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É
      </div>
    </div>

    <!-- MODAL: New Diagram -->
    <div
      id="new-diagram-modal"
      class="modal"
      onclick="if(event.target.id === 'new-diagram-modal') closeModal('new-diagram-modal')"
    >
      <div class="modal-content">
        <div class="modal-header">
          <div class="modal-title">–°–æ–∑–¥–∞—Ç—å –¥–∏–∞–≥—Ä–∞–º–º—É –∫–ª–∞—Å—Å–æ–≤</div>
          <button
            class="modal-close"
            onclick="closeModal('new-diagram-modal')"
            aria-label="–ó–∞–∫—Ä—ã—Ç—å"
          >
            √ó
          </button>
        </div>
        <div class="form-group">
          <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã *</label>
          <input
            type="text"
            id="diagram-name"
            class="form-input"
            placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã"
          />
          <div
            id="diagram-name-error"
            class="form-error"
            style="
              display: none;
              color: #d32f2f;
              font-size: 12px;
              margin-top: 5px;
            "
          >
            –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã
          </div>
        </div>
        <div class="modal-buttons">
          <button
            class="btn btn-secondary"
            onclick="closeModal('new-diagram-modal')"
          >
            –û—Ç–º–µ–Ω–∏—Ç—å
          </button>
          <button class="btn btn-primary" onclick="createDiagram()">
            –°–æ–∑–¥–∞—Ç—å
          </button>
        </div>
      </div>
    </div>

    <script src="data.js"></script>
    <script src="sidebar.js"></script>
    <script>
      let selectedModelId = null;
      let selectedModelName = null;
      let selectedProfileId = null;
      let selectedProfileName = null;
      let contextMenuTarget = null; // Stores the element that triggered context menu
      let contextMenuInitialized = false; // Prevent multiple initializations

      document.addEventListener("DOMContentLoaded", async () => {
        try {
          await loadSampleData();
          updateCurrentProject();
          checkProject();
          renderCurrentProjectStructure();
          updateSidebarTitle();
          updatePageTitle();
          restoreSidebarState();
          restoreProjectsTreeState();
        } catch (error) {
          console.error("Error during initialization:", error);
        }

        if (!contextMenuInitialized) {
          try {
            initContextMenu();
            contextMenuInitialized = true;
          } catch (error) {
            console.error("Error initializing context menu:", error);
          }
        }
      });

      function updateSidebarTitle() {
        const projectId = getCurrentProjectId();
        const titleElement = document.getElementById("sidebar-project-title");

        if (!projectId) {
          titleElement.textContent = "Nautilus.CIM";
          return;
        }

        const project = getProject(projectId);
        if (project) {
          titleElement.textContent = project.name;
        } else {
          titleElement.textContent = "Nautilus.CIM";
        }
      }

      function updatePageTitle() {
        const projectId = getCurrentProjectId();
        const titleElement = document.getElementById("project-title");

        if (!projectId) {
          titleElement.textContent = "Nautilus.CIM";
          return;
        }

        const project = getProject(projectId);
        if (project) {
          titleElement.textContent = project.name;
        } else {
          titleElement.textContent = "Nautilus.CIM";
        }
      }

      function checkProject() {
        const projectId = getCurrentProjectId();
        if (!projectId) {
          document.getElementById("no-project-warning").style.display = "block";
          document.getElementById("models-container").style.display = "none";
          document.getElementById("no-project-warning").style.display = "block";
          document.getElementById("profiles-container").style.display = "none";
        } else {
          document.getElementById("no-project-warning").style.display = "none";
          document.getElementById("models-container").style.display = "block";
          renderModels();

          document.getElementById("no-project-warning").style.display = "none";
          document.getElementById("profiles-container").style.display = "block";
          renderProfiles();
        }

        updateSidebarTitle();
      }

      function renderCurrentProjectStructure() {
        const projectId = getCurrentProjectId();
        const structureNav = document.getElementById(
          "current-project-structure"
        );

        if (!projectId) {
          structureNav.innerHTML =
            '<div class="no-items text-muted">–ù–µ—Ç –ø—Ä–æ–µ–∫—Ç–∞</div>';
          return;
        }

        const project = getProject(projectId);
        if (!project) {
          structureNav.innerHTML =
            '<div class="no-items text-muted">–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>';
          return;
        }

        const expandedProjects = JSON.parse(
          localStorage.getItem("expandedProjects") || "{}"
        );
        const isExpanded = expandedProjects[projectId];

        let html = `
                <div class="project-tree-item">
                    <div class="project-tree-header active">
                        <button class="project-expand-btn" data-project-id="${projectId}" 
                                aria-expanded="${
                                  isExpanded ? "true" : "false"
                                }">
                            <span class="expand-icon">${
                              isExpanded ? "‚ñº" : "‚ñ∂"
                            }</span>
                        </button>
                        <span class="project-name" title="${
                          project.name
                        }" onclick="selectProject(event)">
                            üì¶ ${project.name}
                        </span>
                    </div>
            `;

        if (isExpanded) {
          html += `<div class="project-structure">`;

          // Render Models with full tree structure
          if (project.models && project.models.length > 0) {
            html += `
                        <div class="structure-section">
                            <div class="structure-title">üìã –ú–æ–¥–µ–ª–∏ (${project.models.length})</div>
                            <div class="structure-items">
                    `;

            project.models.forEach((m, idx) => {
              html += renderModelTree(m, 0, `model-${projectId}-${idx}`);
            });

            html += `
                            </div>
                        </div>
                    `;
          }

          // Render Profiles with full tree structure
          if (project.profiles && project.profiles.length > 0) {
            html += `
                        <div class="structure-section">
                            <div class="structure-title">‚öôÔ∏è –ü—Ä–æ—Ñ–∏–ª–∏ (${project.profiles.length})</div>
                            <div class="structure-items">
                    `;

            project.profiles.forEach((p, idx) => {
              html += renderProfileTree(p, 0, `profile-${projectId}-${idx}`);
            });

            html += `
                            </div>
                        </div>
                    `;
          }

          // No items message
          if (
            (!project.models || project.models.length === 0) &&
            (!project.profiles || project.profiles.length === 0)
          ) {
            html += `<div class="structure-empty">–ù–µ—Ç –º–æ–¥–µ–ª–µ–π –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π</div>`;
          }

          html += `</div>`;
        }

        html += `</div>`;
        structureNav.innerHTML = html;

        // Initialize tree expand/collapse functionality
        initializeTreeExpanders();
      }

      function renderModelTree(model, level = 0, baseId = "") {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren = model.rootPackages && model.rootPackages.length > 0;

        let html = `
                <div class="tree-structure-item" style="margin-left: 10px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for models
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="model">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          model.id || ""
                        }" data-type="model" data-model-id="${
          model.id || ""
        }" onclick="selectModelFromTree(event, ${model.id || ""}, '${
          model.name || ""
        }')">üî∑ ${model.name || "–ú–æ–¥–µ–ª—å –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"}</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;
          model.rootPackages.forEach((rootPkg, idx) => {
            html += renderRootPackageTree(
              rootPkg,
              level + 1,
              `${baseId}-root-${idx}`,
              model.id
            );
          });
          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderLinkItemContent(link) {
        let icon = "üîó";
        let linkLabel = "";

        if (link.relation_kind === "Generalization") {
          icon = "üîº";
          if (link.role === "child") {
            linkLabel = `–Ω–∞—Å–ª–µ–¥—É–µ—Ç—Å—è –æ—Ç ${link.target_class_name || "Unknown"}`;
          } else if (link.role === "parent") {
            linkLabel = `—Ä–æ–¥–∏—Ç–µ–ª—å –¥–ª—è ${link.target_class_name || "Unknown"}`;
          } else {
            linkLabel = link.target_class_name || "Unknown";
          }
        } else if (link.relation_kind === "Association") {
          icon = "‚Üí";
          linkLabel =
            link.target_class_role_name || link.target_class_name || "Unknown";
        }

        const multiplicity = link.multiplicity ? ` [${link.multiplicity}]` : "";
        return `${icon} ${linkLabel}${multiplicity}`;
      }

      function renderLinkItem(link) {
        return `
                <div class="tree-structure-item" style="margin-left: 10px;">
                  <div class="flex">
                    <span class="tree-expand-btn-empty"></span>
                    <span class="tree-structure-name" data-id="${
                      link.assoc_id || link.id || ""
                    }" data-type="link" onclick="selectTreeItem(event)">${renderLinkItemContent(
          link
        )}</span>
                    </div>
                </div>
            `;
      }

      function renderElementTree(elem, level = 0, baseId = "", modelId = null) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (elem.attributes && elem.attributes.length > 0) ||
          (elem.links && elem.links.length > 0);

        const typeIcons = {
          Class: "üìÑ",
          Interface: "‚¨ü",
          Enumeration: "‚ñ£",
          Package: "üì¶",
        };
        const icon = typeIcons[elem.type] || "üìÑ";
        const abstractMarker = elem.isAbstract ? " (abstract)" : "";

        let html = `
                <div class="tree-structure-item" style="margin-left: 10px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for elements
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="element">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          elem.id || ""
                        }" data-type="element" data-model-id="${
          modelId || ""
        }" onclick="selectTreeItem(event)">${icon} ${
          elem.name || "–≠–ª–µ–º–µ–Ω—Ç"
        }${abstractMarker}</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          if (elem.attributes && elem.attributes.length > 0) {
            elem.attributes.forEach((attr, idx) => {
              html += `
                            <div class="tree-structure-item" style="margin-left: 10px;">
                              <div class="flex">
                                <span class="tree-expand-btn-empty"></span>
                                <span class="tree-structure-name" data-id="${
                                  attr.id || ""
                                }" data-type="attribute" onclick="selectTreeItem(event)">üîπ ${
                attr.name
              }: ${attr.type}${
                attr.multiplicity ? " [" + attr.multiplicity + "]" : ""
              }</span>
              </div>
                            </div>
                        `;
            });
          }

          if (elem.links && elem.links.length > 0) {
            elem.links.forEach((link, idx) => {
              html += renderLinkItem(link);
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderProfileTree(profile, level = 0, baseId = "") {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];

        // Check for both attributes and rootPackages as children
        const hasAttributes =
          profile.attributes && profile.attributes.length > 0;
        const hasRootPackages =
          profile.rootPackages && profile.rootPackages.length > 0;
        const hasChildren = hasAttributes || hasRootPackages;

        let html = `
                <div class="tree-structure-item" style="margin-left: 10px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for profiles
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="profile">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        const profileNameEscaped = (
          profile.name || "–ü—Ä–æ—Ñ–∏–ª—å –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
        ).replace(/'/g, "\\'");
        html += `
                        <span class="tree-structure-name" data-id="${
                          profile.id || ""
                        }" data-type="profile" data-profile-id="${
          profile.id || ""
        }" onclick="selectProfileFromTree(event, ${
          profile.id || ""
        }, '${profileNameEscaped}')">‚ö° ${
          profile.name || "–ü—Ä–æ—Ñ–∏–ª—å –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è"
        }</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          // Render root packages if they exist
          if (hasRootPackages) {
            profile.rootPackages.forEach((rootPkg, idx) => {
              html += renderProfileRootPackageTree(
                rootPkg,
                0,
                `${baseId}-root-${idx}`,
                profile.id
              );
            });
          }

          // Render attributes if they exist
          if (hasAttributes) {
            profile.attributes.forEach((attr, idx) => {
              html += `
                        <div class="tree-structure-item" style="margin-left: 10px;">
                          <div class="flex">
                            <span class="tree-expand-btn-empty"></span>
                            <span class="tree-structure-name" data-id="${
                              attr.id || ""
                            }" data-type="profile-attribute" data-profile-id="${
                profile.id || ""
              }" onclick="selectTreeItem(event)">‚Ä¢ ${
                attr.name || "–ê—Ç—Ä–∏–±—É—Ç"
              }</span>
            </div>
                        </div>
                    `;
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderProfileRootPackageTree(
        rootPkg,
        level = 0,
        baseId = "",
        profileId = null
      ) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (rootPkg.children && rootPkg.children.length > 0) ||
          (rootPkg.elements && rootPkg.elements.length > 0) ||
          (rootPkg.diagrams && rootPkg.diagrams.length > 0);

        let html = `
                <div class="tree-structure-item" style="margin-left: 20px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for packages
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="package">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        const typeLabel = rootPkg.type === "Model" ? "üóÇÔ∏è" : "üì¶";
        html += `
                        <span class="tree-structure-name" data-id="${
                          rootPkg.id || ""
                        }" data-type="package" data-profile-id="${
          profileId || ""
        }" onclick="selectTreeItem(event)" oncontextmenu="handlePackageContextMenu(event)">${typeLabel} ${
          rootPkg.name || "–ö–æ—Ä–Ω–µ–≤–æ–π –ø–∞–∫–µ—Ç"
        }</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          // Render diagrams first
          if (rootPkg.diagrams && rootPkg.diagrams.length > 0) {
            rootPkg.diagrams.forEach((diagram, idx) => {
              html += `
                <div class="tree-structure-item" style="margin-left: 20px;">
                  <div class="flex">
                    <span class="tree-expand-btn-empty"></span>
                    <span class="tree-structure-name" data-id="${
                      diagram.id || ""
                    }" data-type="diagram" data-profile-id="${
                profileId || ""
              }" onclick="selectTreeItem(event)">üìê ${
                diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞"
              }</span>
                  </div>
                </div>
              `;
            });
          }

          // Render child packages
          if (rootPkg.children && rootPkg.children.length > 0) {
            rootPkg.children.forEach((pkg, idx) => {
              html += renderProfilePackageTree(
                pkg,
                level + 1,
                `${baseId}-pkg-${idx}`,
                profileId
              );
            });
          }

          // Render elements
          if (rootPkg.elements && rootPkg.elements.length > 0) {
            rootPkg.elements.forEach((elem, idx) => {
              html += renderProfileElementTree(
                elem,
                level + 1,
                `${baseId}-elem-${idx}`,
                profileId
              );
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderProfilePackageTree(
        pkg,
        level = 0,
        baseId = "",
        profileId = null
      ) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (pkg.children && pkg.children.length > 0) ||
          (pkg.elements && pkg.elements.length > 0) ||
          (pkg.diagrams && pkg.diagrams.length > 0);

        let html = `
                <div class="tree-structure-item" style="margin-left: 20px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for packages
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="package">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          pkg.id || ""
                        }" data-type="package" data-profile-id="${
          profileId || ""
        }" onclick="selectTreeItem(event)" oncontextmenu="handlePackageContextMenu(event)">üìÅ ${
          pkg.name || "–ü–∞–∫–µ—Ç"
        }</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          // Render diagrams first
          if (pkg.diagrams && pkg.diagrams.length > 0) {
            pkg.diagrams.forEach((diagram, idx) => {
              html += `
                <div class="tree-structure-item" style="margin-left: 20px;">
                  <div class="flex">
                    <span class="tree-expand-btn-empty"></span>
                    <span class="tree-structure-name" data-id="${
                      diagram.id || ""
                    }" data-type="diagram" data-profile-id="${
                profileId || ""
              }" onclick="selectTreeItem(event)">üìê ${
                diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞"
              }</span>
                  </div>
                </div>
              `;
            });
          }

          // Render child packages
          if (pkg.children && pkg.children.length > 0) {
            pkg.children.forEach((subPkg, idx) => {
              html += renderProfilePackageTree(
                subPkg,
                level + 1,
                `${baseId}-pkg-${idx}`,
                profileId
              );
            });
          }

          // Render elements
          if (pkg.elements && pkg.elements.length > 0) {
            pkg.elements.forEach((elem, idx) => {
              html += renderProfileElementTree(
                elem,
                level + 1,
                `${baseId}-elem-${idx}`,
                profileId
              );
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderProfileElementTree(
        elem,
        level = 0,
        baseId = "",
        profileId = null
      ) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (elem.attributes && elem.attributes.length > 0) ||
          (elem.links && elem.links.length > 0);

        const typeIcons = {
          Class: "üìÑ",
          Interface: "‚¨ü",
          Enumeration: "‚ñ£",
          Package: "üì¶",
        };
        const icon = typeIcons[elem.type] || "üìÑ";
        const abstractMarker = elem.isAbstract ? " (abstract)" : "";

        let html = `
                <div class="tree-structure-item" style="margin-left: 20px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for elements
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="element">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          elem.id || ""
                        }" data-type="element" data-profile-id="${
          profileId || ""
        }" onclick="selectTreeItem(event)">${icon} ${
          elem.name || "–≠–ª–µ–º–µ–Ω—Ç"
        }${abstractMarker}</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          if (elem.attributes && elem.attributes.length > 0) {
            elem.attributes.forEach((attr, idx) => {
              const defaultValue = attr.default ? ` = ${attr.default}` : "";
              html += `
                            <div class="tree-structure-item" style="margin-left: 20px;">
                                <span class="tree-expand-btn-empty"></span>
                                <span class="tree-structure-name" data-id="${
                                  attr.id || ""
                                }" data-type="attribute" data-profile-id="${
                profileId || ""
              }" onclick="selectTreeItem(event)">üîπ ${attr.name}: ${attr.type}${
                attr.multiplicity ? " [" + attr.multiplicity + "]" : ""
              }${defaultValue}</span>
                            </div>
                        `;
            });
          }

          if (elem.links && elem.links.length > 0) {
            elem.links.forEach((link, idx) => {
              html += `
                            <div class="tree-structure-item" style="margin-left: 20px;">
                              <div class="flex">
                                <span class="tree-expand-btn-empty"></span>
                                <span class="tree-structure-name" data-id="${
                                  link.assoc_id || link.id || ""
                                }" data-type="link" data-profile-id="${
                profileId || ""
              }" onclick="selectTreeItem(event)">${renderLinkItemContent(
                link
              )}</span>
                                </div>
                            </div>
                        `;
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function selectDiagram(event, diagramId, diagramName, modelId) {
        event.stopPropagation();

        // Remove selection from all tree items
        document.querySelectorAll(".tree-structure-name").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selection to clicked diagram
        event.target.classList.add("selected");

        // Enable diagram mode
        const contentArea = document.querySelector(".content-area");
        contentArea.classList.add("diagram-mode-on");

        // Hide models, profiles and item containers
        document.getElementById("models-container").classList.add("hidden");
        document.getElementById("profiles-container").classList.add("hidden");
        document.getElementById("item-container").classList.add("hidden");
        document.getElementById("models-container").style.display = "none";
        document.getElementById("profiles-container").style.display = "none";
        document.getElementById("item-container").style.display = "none";

        // Show diagram mode content
        const diagramodeContent = document.getElementById(
          "diagram-mode-content"
        );
        diagramodeContent.classList.remove("hidden");
        diagramodeContent.classList.add("diagram-mode-content-on");

        // Render diagram content
        renderdiagramode(diagramId, diagramName, modelId);
      }

      function renderdiagramode(diagramId, diagramName, modelId) {
        // Render diagram container (placeholder for now)
        document.getElementById("diagram-container").innerHTML = `
          <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: var(--text-secondary);">
            <div style="text-align: center;">
              <div style="font-size: 48px; margin-bottom: 15px;">üìê</div>
              <h3>–î–∏–∞–≥—Ä–∞–º–º–∞: ${diagramName}</h3>
              <p>–í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–∏–∞–≥—Ä–∞–º–º—ã –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –ø–æ–∑–∂–µ</p>
            </div>
          </div>
        `;

        // Render tabs in item-container-diagram
        document.getElementById("item-container-diagram").innerHTML = `
          <div class="tabs">
            <div class="tab active" onclick="switchDiagramTab('general')">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</div>
            <div class="tab" onclick="switchDiagramTab('attributes')">–ê—Ç—Ä–∏–±—É—Ç—ã</div>
            <div class="tab" onclick="switchDiagramTab('links')">–°–≤—è–∑–∏</div>
          </div>

          <div id="diagram-tab-general" class="tab-content active">
            <h4 style="margin-bottom: 10px;">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
            <table class="table">
              <tr>
                <td style="font-weight:600; width:200px;">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–∏–∞–≥—Ä–∞–º–º—ã</td>
                <td>${diagramName}</td>
              </tr>
              <tr>
                <td style="font-weight:600;">–¢–∏–ø –¥–∏–∞–≥—Ä–∞–º–º—ã</td>
                <td>–î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤</td>
              </tr>
              <tr>
                <td style="font-weight:600;">ID –¥–∏–∞–≥—Ä–∞–º–º—ã</td>
                <td>${diagramId}</td>
              </tr>
            </table>
          </div>

          <div id="diagram-tab-attributes" class="tab-content">
            <h4 style="margin-bottom: 10px;">–ê—Ç—Ä–∏–±—É—Ç—ã</h4>
            <div class="text-muted">–ê—Ç—Ä–∏–±—É—Ç—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –∫–ª–∞—Å—Å–æ–≤ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</div>
          </div>

          <div id="diagram-tab-links" class="tab-content">
            <h4 style="margin-bottom: 10px;">–°–≤—è–∑–∏</h4>
            <div class="text-muted">–°–≤—è–∑–∏ –º–µ–∂–¥—É –∫–ª–∞—Å—Å–∞–º–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å</div>
          </div>
        `;
      }

      function switchDiagramTab(tabName) {
        // Remove active class from all tabs
        document
          .querySelectorAll("#item-container-diagram .tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll("#item-container-diagram .tab-content")
          .forEach((t) => t.classList.remove("active"));

        // Add active class to selected tab
        event.target.classList.add("active");
        document
          .getElementById("diagram-tab-" + tabName)
          .classList.add("active");
      }

      function renderRootPackageTree(
        rootPkg,
        level = 0,
        baseId = "",
        modelId = null
      ) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (rootPkg.children && rootPkg.children.length > 0) ||
          (rootPkg.elements && rootPkg.elements.length > 0) ||
          (rootPkg.diagrams && rootPkg.diagrams.length > 0);

        let html = `
                <div class="tree-structure-item" style="margin-left: 10px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for packages
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="package">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          rootPkg.id || ""
                        }" data-type="package" data-model-id="${
          modelId || ""
        }" onclick="selectTreeItem(event)" oncontextmenu="handlePackageContextMenu(event)">üì¶ ${
          rootPkg.name || "–ö–æ—Ä–Ω–µ–≤–æ–π –ø–∞–∫–µ—Ç"
        }</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          // –†–µ–Ω–¥–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º –ø–∞–∫–µ—Ç–∞
          if (rootPkg.diagrams && rootPkg.diagrams.length > 0) {
            rootPkg.diagrams.forEach((diagram, idx) => {
              const diagramNameEscaped = (diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞").replace(
                /'/g,
                "\\'"
              );
              html += `
                <div class="tree-structure-item" style="margin-left: 10px;">
                  <div class="flex">
                    <span class="tree-expand-btn-empty"></span>
                    <span class="tree-structure-name" data-id="${
                      diagram.id || ""
                    }" data-type="diagram" data-model-id="${
                modelId || ""
              }" onclick="selectDiagram(event, ${
                diagram.id || ""
              }, '${diagramNameEscaped}', ${modelId || ""})">üìê ${
                diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞"
              }</span>
                  </div>
                </div>
              `;
            });
          }

          // –†–µ–Ω–¥–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –∫–æ—Ä–Ω–µ–≤–æ–≥–æ –ø–∞–∫–µ—Ç–∞
          if (rootPkg.elements && rootPkg.elements.length > 0) {
            rootPkg.elements.forEach((elem, idx) => {
              html += renderElementTree(
                elem,
                level + 1,
                `${baseId}-elem-${idx}`,
                modelId
              );
            });
          }

          // –†–µ–Ω–¥–µ—Ä –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
          if (rootPkg.children && rootPkg.children.length > 0) {
            rootPkg.children.forEach((pkg, idx) => {
              html += renderPackageTree(
                pkg,
                level + 1,
                `${baseId}-pkg-${idx}`,
                modelId
              );
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function renderPackageTree(pkg, level = 0, baseId = "", modelId = null) {
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );
        const itemId = baseId;
        const isExpanded = expandedItems[itemId];
        const hasChildren =
          (pkg.children && pkg.children.length > 0) ||
          (pkg.elements && pkg.elements.length > 0) ||
          (pkg.diagrams && pkg.diagrams.length > 0);

        let html = `
                <div class="tree-structure-item" style="margin-left: 10px;">
                    <div class="tree-structure-header">
            `;

        // Always show expand button for packages
        html += `
                    <button class="tree-expand-btn" data-item-id="${itemId}" data-type="package">
                        <span class="tree-expand-icon">${
                          isExpanded ? "‚ñº" : "‚ñ∂"
                        }</span>
                    </button>
                `;

        html += `
                        <span class="tree-structure-name" data-id="${
                          pkg.id || ""
                        }" data-type="package" data-model-id="${
          modelId || ""
        }" onclick="selectTreeItem(event)" oncontextmenu="handlePackageContextMenu(event)">üìÅ ${
          pkg.name || "–ü–∞–∫–µ—Ç"
        }</span>
                    </div>
            `;

        if (hasChildren && isExpanded) {
          html += `<div class="tree-structure-children">`;

          // –†–µ–Ω–¥–µ—Ä –¥–∏–∞–≥—Ä–∞–º–º –ø–∞–∫–µ—Ç–∞
          if (pkg.diagrams && pkg.diagrams.length > 0) {
            pkg.diagrams.forEach((diagram, idx) => {
              const diagramNameEscaped = (diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞").replace(
                /'/g,
                "\\'"
              );
              html += `
                <div class="tree-structure-item" style="margin-left: 10px;">
                  <div class="flex">
                    <span class="tree-expand-btn-empty"></span>
                    <span class="tree-structure-name" data-id="${
                      diagram.id || ""
                    }" data-type="diagram" data-model-id="${
                modelId || ""
              }" onclick="selectDiagram(event, ${
                diagram.id || ""
              }, '${diagramNameEscaped}', ${modelId || ""})">üìê ${
                diagram.name || "–î–∏–∞–≥—Ä–∞–º–º–∞"
              }</span>
                  </div>
                </div>
              `;
            });
          }

          // –†–µ–Ω–¥–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–∞–∫–µ—Ç–∞
          if (pkg.elements && pkg.elements.length > 0) {
            pkg.elements.forEach((elem, idx) => {
              html += renderElementTree(
                elem,
                level + 1,
                `${baseId}-elem-${idx}`,
                modelId
              );
            });
          }

          // –†–µ–Ω–¥–µ—Ä –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
          if (pkg.children && pkg.children.length > 0) {
            pkg.children.forEach((subPkg, idx) => {
              html += renderPackageTree(
                subPkg,
                level + 1,
                `${baseId}-pkg-${idx}`,
                modelId
              );
            });
          }

          html += `</div>`;
        }

        html += `</div>`;
        return html;
      }

      function toggleTreeItem(itemId) {
        console.log("toggleTreeItem called for:", itemId);
        const expandedItems = JSON.parse(
          localStorage.getItem("expandedTreeItems") || "{}"
        );

        if (expandedItems[itemId]) {
          delete expandedItems[itemId];
        } else {
          expandedItems[itemId] = true;
        }

        // console.log("expandedItems after toggle:", expandedItems);
        localStorage.setItem(
          "expandedTreeItems",
          JSON.stringify(expandedItems)
        );
        renderCurrentProjectStructure();
      }

      function initializeTreeExpanders() {
        const buttons = document.querySelectorAll(".tree-expand-btn");
        console.log("Found tree expand buttons:", buttons.length);
        buttons.forEach((btn) => {
          btn.addEventListener("click", function (e) {
            e.stopPropagation();
            const itemId = this.getAttribute("data-item-id");
            // console.log("Tree button clicked, itemId:", itemId);
            toggleTreeItem(itemId);
          });
        });

        // Also add listener for project expand button
        const projectBtn = document.querySelector(".project-expand-btn");
        if (projectBtn) {
          projectBtn.addEventListener("click", function (e) {
            e.stopPropagation();
            const projectId = parseInt(this.getAttribute("data-project-id"));
            // console.log("Project button clicked, projectId:", projectId);
            toggleCurrentProjectStructure(projectId);
          });
        }
      }

      function toggleCurrentProjectStructure(projectId) {
        const expandedProjects = JSON.parse(
          localStorage.getItem("expandedProjects") || "{}"
        );

        if (expandedProjects[projectId]) {
          delete expandedProjects[projectId];
        } else {
          expandedProjects[projectId] = true;
        }

        localStorage.setItem(
          "expandedProjects",
          JSON.stringify(expandedProjects)
        );
        renderCurrentProjectStructure();
      }

      function renderModels() {
        const projectId = getCurrentProjectId();
        const models = getModels(projectId);

        const html = models
          .map(
            (m) => `
                <div class="tree-item ${
                  selectedModelId === m.id ? "selected" : ""
                }" onclick="selectModel(${m.id}, '${m.name}')">
                    üì¶ ${m.name}
                </div>
            `
          )
          .join("");

        document.getElementById("models-list").innerHTML =
          html || '<div class="no-items text-muted">–ù–µ—Ç –º–æ–¥–µ–ª–µ–π</div>';
      }

      function selectModel(modelId, modelName) {
        selectedModelId = modelId;
        selectedModelName = modelName;
        renderModels();
        renderModelDetails();
        document.getElementById("diagram-btn").style.display = "inline-flex";
      }

      function renderProfiles() {
        const projectId = getCurrentProjectId();
        const profiles = getProfiles(projectId);
        // console.log("Rendering profiles:", profiles);

        const html = profiles
          .map(
            (p) => `
                <div class="tree-item ${
                  selectedProfileId === p.id ? "selected" : ""
                }" onclick="selectProfile(${p.id}, '${p.name}')">
                    ‚öôÔ∏è ${p.name}
                </div>
            `
          )
          .join("");

        // console.log("Profiles HTML:", html);

        document.getElementById("profiles-list").innerHTML =
          html || '<div class="no-items text-muted">–ù–µ—Ç –ø—Ä–æ—Ñ–∏–ª–µ–π</div>';
      }

      function selectProfile(profileId, profileName) {
        selectedProfileId = profileId;
        selectedProfileName = profileName;
        renderProfiles();
        renderProfileDetails();
        // document.getElementById('diagram-btn').style.display = 'inline-flex';
      }

      function openDiagram() {
        if (!selectedModelName) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ –º–æ–¥–µ–ª—å");
          return;
        }
        window.location.href =
          "diagram.html?model=" + encodeURIComponent(selectedModelName);
      }

      function renderModelDetails() {
        const projectId = getCurrentProjectId();
        const model = getModel(projectId, selectedModelId);

        if (!model) return;

        const structure = getSampleClassStructure();
        const treeHtml = renderTree(structure[model.name] || []);

        const html = `
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('properties')">–°–≤–æ–π—Å—Ç–≤–∞</div>

                </div>
                
                <div id="tab-properties" class="tab-content active">
                    <div class="flex-between mb-15">
                        <h3 class="no-margin">${model.name}</h3>
                        <button class="btn btn-primary btn-small" onclick="openDiagram()">üìê –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤</button>
                    </div>
                    <table class="table model-details-table">
                    <colgroup>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="min-width: 50%;"/>
                  </colgroup>
                        <tr>
                            <td colspan="2">–û–ø–∏—Å–∞–Ω–∏–µ</td>
                            <td colspan="2">${model.description}</td>
                        </tr>
                        <tr>
                            <td>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏: </td>
                            <td><span> ${
                              model.createDate !== null &&
                              model.createDate !== undefined
                                ? model.createDate
                                : "---"
                            }</span></td>
                            <td>–î–∞—Ç–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è: </td>
                            <td><span> ${
                              model.modifyDate !== null &&
                              model.modifyDate !== undefined
                                ? model.modifyDate
                                : "---"
                            }</span></td>
                        </tr>
                        <tr>
                            <td colspan="2">–ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –≤ –ø—Ä–æ—Ñ–∏–ª—è—Ö</td>
                            <td colspan="2">${
                              model.relatedProfiles &&
                              model.relatedProfiles.length > 0
                                ? model.relatedProfiles
                                    .map((p) => p.name)
                                    .join(", ")
                                : "---"
                            }</td>
                        </tr>
                       
                    </table>
                </div>
                
            `;

        document.getElementById("model-details").innerHTML = html;
      }

      function renderProfileDetails() {
        const projectId = getCurrentProjectId();
        const profile = getProfile(projectId, selectedProfileId);

        if (!profile) return;

        const xsdCode =
          profile.xsd ||
          `<?xml version="1.0" encoding="UTF-8"?>
<xs:schema xmlns:xs="http://www.w3.org/2001/XMLSchema">
  <!-- –ü—Ä–æ—Ñ–∏–ª—å ${profile.name} -->
  <xs:element name="Profile" type="ProfileType"/>
  <xs:complexType name="ProfileType">
    <xs:sequence>
      <xs:element name="id" type="xs:string"/>
      <xs:element name="name" type="xs:string"/>
    </xs:sequence>
  </xs:complexType>
</xs:schema>`;

        const html = `
                <div class="tabs">
                    <div class="tab active" onclick="switchTab('properties')">–°–≤–æ–π—Å—Ç–≤–∞</div>
                    <div class="tab" onclick="switchTab('structure')">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∫–ª–∞—Å—Å–æ–≤</div>
                    <div class="tab" onclick="switchTab('xsd')">XSD –∫–æ–¥</div>
                </div>
                
                <div id="tab-properties" class="tab-content active">
                    <div class="flex-between mb-15">
                        <h3 class="no-margin">${profile.name}</h3>
                        <button class="btn btn-primary btn-small" onclick="openDiagram()">üìê –î–∏–∞–≥—Ä–∞–º–º–∞ –∫–ª–∞—Å—Å–æ–≤</button>
                    </div>
                    <table class="table">
                        <tr>
                            <td class="table-label">–ë–∞–∑–æ–≤–∞—è –º–æ–¥–µ–ª—å</td>
                            <td><span class="badge">${
                              profile.baseModel
                            }</span></td>
                        </tr>
                        <tr>
                            <td class="table-label">–í–µ—Ä—Å–∏—è</td>
                            <td>${profile.version}</td>
                        </tr>
                        <tr>
                            <td class="table-label">–û–ø–∏—Å–∞–Ω–∏–µ</td>
                            <td>${profile.description}</td>
                        </tr>
                        <tr>
                            <td class="table-label">–ö–ª–∞—Å—Å–æ–≤ –≤ –ø—Ä–æ—Ñ–∏–ª–µ</td>
                            <td>${profile.classes}</td>
                        </tr>
                        <tr>
                            <td class="table-label">–ê—Ç—Ä–∏–±—É—Ç–æ–≤</td>
                            <td>${profile.attributes}</td>
                        </tr>
                    </table>
                    
                    <div id="tab-properties" class="mt-20">
                        <button class="btn btn-primary" onclick="window.location.href='profile-editor.html?profileId=${
                          profile.id
                        }'">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-primary" onclick="alert('–§—É–Ω–∫—Ü–∏—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">üì• –≠–∫—Å–ø–æ—Ä—Ç XSD</button>
                        <button class="btn btn-secondary" onclick="alert('–§—É–Ω–∫—Ü–∏—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ')">‚úì –í–∞–ª–∏–¥–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
                
                <div id="tab-structure" class="tab-content">
                    <h3 class="mb-15">–ö–ª–∞—Å—Å—ã –ø—Ä–æ—Ñ–∏–ª—è</h3>
                    <div class="tree">
                        <div class="tree-item">üì¶ ${profile.baseModel}</div>
                        <div class="tree-children">
                            <div class="tree-item">üìÅ AssetInfo</div>
                            <div class="tree-children">
                                <div class="tree-item">üìÑ RotatingMachineInfo <span class="badge-secondary">rf</span></div>
                                <div class="tree-children">
                                    <div class="tree-item">‚Ä¢ rotorGD2: Torque [0..1]</div>
                                    <div class="tree-item">‚Ä¢ ratedVoltage: Voltage [1]</div>
                                </div>
                                <div class="tree-item">üìÑ SynchronousMachineInfo</div>
                                <div class="tree-item">üìÑ AsynchronousMachineInfo</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="tab-xsd" class="tab-content">
                    <h3 class="mb-15">XSD Schema</h3>
                    <div class="code-block">${escapeHtml(xsdCode)}</div>
                    <div class="mt-15">
                        <button class="btn btn-secondary" onclick="copyCode()">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                    </div>
                </div>
            `;

        document.getElementById("profile-details").innerHTML = html;
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function renderTree(items, level = 0) {
        return items
          .map((item) => {
            const icon =
              item.type === "package"
                ? "üìÅ"
                : item.type === "class"
                ? "üìÑ"
                : "‚Ä¢";
            const children = item.children
              ? `<div class="tree-children">${renderTree(
                  item.children,
                  level + 1
                )}</div>`
              : "";
            return `
                    <div>
                        <div class="tree-item tree-item-dynamic" style="padding-left:${
                          level * 20 + 10
                        }px;">
                            ${icon} ${item.name}
                            ${
                              item.stereotype
                                ? `<span class="badge-secondary">${item.stereotype}</span>`
                                : ""
                            }
                        </div>
                        ${children}
                    </div>
                `;
          })
          .join("");
      }

      function switchTab(tabName) {
        document
          .querySelectorAll(".tab")
          .forEach((t) => t.classList.remove("active"));
        document
          .querySelectorAll(".tab-content")
          .forEach((t) => t.classList.remove("active"));

        event.target.classList.add("active");
        document.getElementById("tab-" + tabName).classList.add("active");
      }

      function selectProject(event) {
        event.stopPropagation();

        // Remove selection from all tree items
        document.querySelectorAll(".tree-structure-name").forEach((el) => {
          el.classList.remove("selected");
        });

        // Hide item container
        document.getElementById("item-container").style.display = "none";
        document.getElementById("item-container").classList.add("hidden");

        // Show models and profiles containers
        document.getElementById("models-container").style.display = "block";
        document.getElementById("models-container").classList.remove("hidden");
        document.getElementById("profiles-container").style.display = "block";
        document
          .getElementById("profiles-container")
          .classList.remove("hidden");
      }

      function selectModelFromTree(event, modelId, modelName) {
        event.stopPropagation();

        // Remove selection from all tree items
        document.querySelectorAll(".tree-structure-name").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selection to clicked model
        event.target.classList.add("selected");

        // Hide item container
        document.getElementById("item-container").style.display = "none";
        document.getElementById("item-container").classList.add("hidden");

        // Show models and profiles containers
        document.getElementById("models-container").style.display = "block";
        document.getElementById("models-container").classList.remove("hidden");
        document.getElementById("profiles-container").style.display = "block";
        document
          .getElementById("profiles-container")
          .classList.remove("hidden");

        // Select the model
        selectedModelId = modelId;
        selectedModelName = modelName;
        renderModels();
        renderModelDetails();
        document.getElementById("diagram-btn").style.display = "inline-flex";
      }

      function selectProfileFromTree(event, profileId, profileName) {
        event.stopPropagation();

        // Remove selection from all tree items
        document.querySelectorAll(".tree-structure-name").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selection to clicked profile
        event.target.classList.add("selected");

        // Hide item container
        document.getElementById("item-container").style.display = "none";
        document.getElementById("item-container").classList.add("hidden");

        // Show models and profiles containers
        document.getElementById("models-container").style.display = "block";
        document.getElementById("models-container").classList.remove("hidden");
        document.getElementById("profiles-container").style.display = "block";
        document
          .getElementById("profiles-container")
          .classList.remove("hidden");

        // Select the profile
        selectedProfileId = profileId;
        selectedProfileName = profileName;
        renderProfiles();
        renderProfileDetails();
      }

      function selectTreeItem(event) {
        event.stopPropagation();
        const target = event.target;
        const itemId = target.getAttribute("data-id");
        const itemType = target.getAttribute("data-type");
        const modelId = target.getAttribute("data-model-id");
        const profileId = target.getAttribute("data-profile-id");

        // Remove previous selection
        document.querySelectorAll(".tree-structure-name").forEach((el) => {
          el.classList.remove("selected");
        });

        // Add selection to clicked item
        target.classList.add("selected");

        // Hide models and profiles containers
        document.getElementById("models-container").style.display = "none";
        document.getElementById("profiles-container").style.display = "none";

        // Show item container
        const itemContainer = document.getElementById("item-container");
        itemContainer.style.display = "block";
        itemContainer.classList.remove("hidden");

        // Render appropriate item details based on context
        if (profileId) {
          // Profile tree item
          renderProfileItemDetails(itemId, itemType, profileId);
        } else {
          // Model tree item
          renderItemDetails(itemId, itemType, modelId);
        }
      }

      function renderProfileItemDetails(itemId, itemType, profileId) {
        const projectId = getCurrentProjectId();
        const project = getProject(projectId);

        if (!project) return;

        let itemData = null;
        let parentElement = null;
        let profileContext = null;

        // Find the profile
        const profile = project.profiles.find((p) => p.id == profileId);
        if (!profile) {
          document.getElementById("item-container").innerHTML = `
            <div class="text-center">–ü—Ä–æ—Ñ–∏–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
          `;
          return;
        }

        // Search only in the specific profile's rootPackages
        if (profile.rootPackages) {
          const result = findItemInProfile(
            profile.rootPackages,
            itemId,
            itemType
          );
          if (result) {
            if (result.item) {
              itemData = result.item;
              parentElement = result.parent;
            } else {
              itemData = result;
            }
            profileContext = profile;
          }
        }

        if (!itemData) {
          document.getElementById("item-container").innerHTML = `
            <div class="text-center">–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
          `;
          return;
        }

        // For attribute or link, render the parent element details
        if (
          (itemType === "attribute" || itemType === "link") &&
          parentElement
        ) {
          itemData = parentElement;
          itemType = "element";
        }

        let html = "";

        // Render based on item type
        if (itemType === "package") {
          // For package - render only basic info without attributes and links
          html = `
            <div class="item-details">
              <div class="item-details-grid mb-10">
                <div class="form-group form-group-flex form-group-flex-start">
                  <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input type="text" value="${
                    itemData.name || ""
                  }" class="form-input" disabled>
                </div>
              </div>
              
              <div class="item-details-grid mb-10">
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–¥–µ–ª—å)</label>
                  <textarea class="form-textarea">${
                    itemData.description_en || itemData.description || ""
                  }</textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ–ø., —Ä—É—Å.)</label>
                  <textarea class="form-textarea">${
                    itemData.description_ru || ""
                  }</textarea>
                </div>
              </div>
              
              <div class="form-group mb-20">
                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä—É—Å)</label>
                <textarea class="form-textarea">${
                  itemData.details || ""
                }</textarea>
              </div>
            </div>
          `;
        } else if (itemType === "element") {
          // For element - render full details with attributes and links
          html = `
            <div class="item-details">
              <div class="item-details-grid mb-10">
                <div class="form-group form-group-flex form-group-flex-start">
                  <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input type="text" value="${
                    itemData.name || ""
                  }" class="form-input" disabled>
                </div>
                
                <div class="item-details-right">
                  <div class="form-group-flex form-group-flex-center">
                    <label class="form-label">–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å</label>
                    <input type="checkbox" ${
                      itemData.isAbstract ? "checked" : ""
                    } class="form-checkbox">
                  </div>
                  
                  <div class="form-group form-group-flex">
                    <label class="form-label">–°—Ç–µ—Ä–µ–æ—Ç–∏–ø</label>
                    <input type="text" value="${
                      itemData.stereotype || ""
                    }" class="form-input">
                  </div>
                </div>
              </div>
              
              <div class="item-details-grid mb-10">
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–¥–µ–ª—å)</label>
                  <textarea class="form-textarea">${
                    itemData.description_en || itemData.description || ""
                  }</textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ–ø., —Ä—É—Å.)</label>
                  <textarea class="form-textarea">${
                    itemData.description_ru || ""
                  }</textarea>
                </div>
              </div>
              
              <div class="form-group mb-20">
                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä—É—Å)</label>
                <textarea class="form-textarea">${
                  itemData.details || ""
                }</textarea>
              </div>
              
              <div class="item-section">
                <h3 class="mb-15">–ê—Ç—Ä–∏–±—É—Ç—ã</h3>
                <table class="table table-bordered">
                  <colgroup>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="width: 10%;"/>
                    <col style="min-width: 50%;"/>
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="sortable">–ò–º—è ‚ñ≤</th>
                      <th class="sortable">–¢–∏–ø ‚áÖ</th>
                      <th class="sortable">–ú–Ω ‚áÖ</th>
                      <th class="sortable">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      itemData.attributes && itemData.attributes.length > 0
                        ? itemData.attributes
                            .map(
                              (attr) => `
                        <tr>
                          <td><a href="#" class="table-link">${
                            attr.name || ""
                          }</a></td>
                          <td>${attr.type || ""}</td>
                          <td>${attr.multiplicity || ""}</td>
                          <td>${attr.description || ""}</td>
                        </tr>
                      `
                            )
                            .join("")
                        : '<tr><td colspan="4" class="text-center text-muted">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</td></tr>'
                    }
                  </tbody>
                </table>
              </div>
              
              <div class="item-section">
                <h3 class="mb-15">–°–≤—è–∑–∏</h3>
                <table class="table table-bordered">
                  <colgroup>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="min-width: 20%;"/>
                    <col style="width: 5%;"/>
                    <col style="max-width: 50%;"/>
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="sortable">–ò–º—è —Å–≤—è–∑–∏ ‚áÖ</th>
                      <th class="sortable">–¢–∏–ø —Å–≤—è–∑–∏ ‚áÖ</th>
                      <th class="sortable">–ö–ª–∞—Å—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ‚áÖ</th>
                      <th class="sortable">–ú–Ω</th>
                      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      itemData.links && itemData.links.length > 0
                        ? itemData.links
                            .map(
                              (link) => `
                        <tr>
                          <td>${link.target_class_role_name || ""}</td>
                          <td>${link.relation_kind || ""} (${
                                link.role || ""
                              })</td>
                          <td><a href="#" class="table-link">${
                            link.target_class_name || ""
                          }</a></td>
                          <td>${link.multiplicity || ""}</td>
                          <td>${link.description || ""}</td>
                        </tr>
                      `
                            )
                            .join("")
                        : '<tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç —Å–≤—è–∑–µ–π</td></tr>'
                    }
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        document.getElementById("item-container").innerHTML = html;
      }

      function renderItemDetails(itemId, itemType, modelId) {
        const projectId = getCurrentProjectId();
        const project = getProject(projectId);

        if (!project) return;

        let itemData = null;
        let parentElement = null;
        let modelContext = null;

        // If modelId is provided, search only in that specific model
        if (modelId) {
          const model = project.models.find((m) => m.id == modelId);
          if (model) {
            const result = findItemInModel(model, itemId, itemType);
            if (result) {
              if (result.item) {
                itemData = result.item;
                parentElement = result.parent;
              } else {
                itemData = result;
              }
              modelContext = model;
            }
          }
        } else {
          // Fallback: search through all models if modelId is not provided
          for (const model of project.models) {
            const result = findItemInModel(model, itemId, itemType);
            if (result) {
              if (result.item) {
                itemData = result.item;
                parentElement = result.parent;
              } else {
                itemData = result;
              }
              modelContext = model;
              break;
            }
          }
        }

        // Search through profiles if not found in models
        if (!itemData && itemType === "profile") {
          itemData = project.profiles.find((p) => p.id == itemId);
        }

        if (!itemData) {
          document.getElementById("item-container").innerHTML = `
            <div class="text-center">–≠–ª–µ–º–µ–Ω—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω</div>
          `;
          return;
        }

        // For attribute or link, render the parent element details
        if (
          (itemType === "attribute" || itemType === "link") &&
          parentElement
        ) {
          itemData = parentElement;
          itemType = "element";
        }

        let html = "";

        // Render based on item type
        if (itemType === "package") {
          // For package - render only basic info without attributes and links
          html = `
            <div class="item-details">
              <div class="item-details-grid mb-10">
                <div class="form-group form-group-flex form-group-flex-start">
                  <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input type="text" value="${
                    itemData.name || ""
                  }" class="form-input" disabled>
                </div>
              </div>
              
              <div class="item-details-grid mb-10">
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–¥–µ–ª—å)</label>
                  <textarea class="form-textarea">${
                    itemData.description_en || itemData.description || ""
                  }</textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ–ø., —Ä—É—Å.)</label>
                  <textarea class="form-textarea">${
                    itemData.description_ru || ""
                  }</textarea>
                </div>
              </div>
              
              <div class="form-group mb-20">
                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä—É—Å)</label>
                <textarea class="form-textarea">${
                  itemData.details || ""
                }</textarea>
              </div>
            </div>
          `;
        } else if (itemType === "element") {
          // For element - render full details with attributes and links
          html = `
            <div class="item-details">
              <div class="item-details-grid mb-10">
                <div class="form-group form-group-flex form-group-flex-start">
                  <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                  <input type="text" value="${
                    itemData.name || ""
                  }" class="form-input" disabled>
                </div>
                
                <div class="item-details-right">
                  <div class="form-group-flex form-group-flex-center">
                    <label class="form-label">–ê–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–π –∫–ª–∞—Å—Å</label>
                    <input type="checkbox" ${
                      itemData.isAbstract ? "checked" : ""
                    } class="form-checkbox">
                  </div>
                  
                  <div class="form-group form-group-flex">
                    <label class="form-label">–°—Ç–µ—Ä–µ–æ—Ç–∏–ø</label>
                    <input type="text" value="${
                      itemData.stereotype || ""
                    }" class="form-input">
                  </div>
                </div>
              </div>
              
              <div class="item-details-grid mb-10">
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–º–æ–¥–µ–ª—å)</label>
                  <textarea class="form-textarea">${
                    itemData.description_en || itemData.description || ""
                  }</textarea>
                </div>
                
                <div class="form-group">
                  <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–¥–æ–ø., —Ä—É—Å.)</label>
                  <textarea class="form-textarea">${
                    itemData.description_ru || ""
                  }</textarea>
                </div>
              </div>
              
              <div class="form-group mb-20">
                <label class="form-label">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Ä—É—Å)</label>
                <textarea class="form-textarea">${
                  itemData.details || ""
                }</textarea>
              </div>
              
              <div class="item-section">
                <h3 class="mb-15">–ê—Ç—Ä–∏–±—É—Ç—ã</h3>
                <table class="table table-bordered">
                  <colgroup>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="width: 10%;"/>
                    <col style="min-width: 50%;"/>
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="sortable">–ò–º—è ‚ñ≤</th>
                      <th class="sortable">–¢–∏–ø ‚áÖ</th>
                      <th class="sortable">–ú–Ω ‚áÖ</th>
                      <th class="sortable">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      itemData.attributes && itemData.attributes.length > 0
                        ? itemData.attributes
                            .map(
                              (attr) => `
                        <tr>
                          <td><a href="#" class="table-link">${
                            attr.name || ""
                          }</a></td>
                          <td>${attr.type || ""}</td>
                          <td>${attr.multiplicity || ""}</td>
                          <td>${attr.description || ""}</td>
                        </tr>
                      `
                            )
                            .join("")
                        : '<tr><td colspan="4" class="text-center text-muted">–ù–µ—Ç –∞—Ç—Ä–∏–±—É—Ç–æ–≤</td></tr>'
                    }
                  </tbody>
                </table>
              </div>
              
              <div class="item-section">
                <h3 class="mb-15">–°–≤—è–∑–∏</h3>
                <table class="table table-bordered">
                  <colgroup>
                    <col style="width: 15%;"/>
                    <col style="width: 15%;"/>
                    <col style="min-width: 20%;"/>
                    <col style="width: 5%;"/>
                    <col style="max-width: 50%;"/>
                  </colgroup>
                  <thead>
                    <tr>
                      <th class="sortable">–ò–º—è —Å–≤—è–∑–∏ ‚áÖ</th>
                      <th class="sortable">–¢–∏–ø —Å–≤—è–∑–∏ ‚áÖ</th>
                      <th class="sortable">–ö–ª–∞—Å—Å –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è ‚áÖ</th>
                      <th class="sortable">–ú–Ω</th>
                      <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${
                      itemData.links && itemData.links.length > 0
                        ? itemData.links
                            .map(
                              (link) => `
                        <tr>
                          <td>${link.target_class_role_name || ""}</td>
                          <td>${link.relation_kind || ""} (${
                                link.role || ""
                              })</td>
                          <td><a href="#" class="table-link">${
                            link.target_class_name || ""
                          }</a></td>
                          <td>${link.multiplicity || ""}</td>
                          <td>${link.description || ""}</td>
                        </tr>
                      `
                            )
                            .join("")
                        : '<tr><td colspan="5" class="text-center text-muted">–ù–µ—Ç —Å–≤—è–∑–µ–π</td></tr>'
                    }
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }

        document.getElementById("item-container").innerHTML = html;
      }

      function findItemInProfile(rootPackages, itemId, itemType) {
        // Search in rootPackages
        if (rootPackages && Array.isArray(rootPackages)) {
          for (const rootPkg of rootPackages) {
            const result = findItemInPackage(rootPkg, itemId, itemType);
            if (result) return result;
          }
        }

        return null;
      }

      function findItemInModel(model, itemId, itemType) {
        // Check if it's the model itself
        if (itemType === "model" && model.id == itemId) {
          return model;
        }

        // Search in rootPackages
        if (model.rootPackages) {
          for (const rootPkg of model.rootPackages) {
            const result = findItemInPackage(rootPkg, itemId, itemType);
            if (result) return result;
          }
        }

        return null;
      }

      function findItemInPackage(pkg, itemId, itemType) {
        // Check if it's the package itself
        if (itemType === "package" && pkg.id == itemId) {
          return pkg;
        }

        // Search in elements
        if (pkg.elements) {
          for (const elem of pkg.elements) {
            if (itemType === "element" && elem.id == itemId) {
              return elem;
            }

            // Search in attributes - return parent element
            if (elem.attributes && itemType === "attribute") {
              const attr = elem.attributes.find((a) => a.id == itemId);
              if (attr) {
                return {
                  item: attr,
                  parent: elem,
                };
              }
            }

            // Search in links - return parent element
            if (elem.links && itemType === "link") {
              const link = elem.links.find(
                (l) => (l.assoc_id || l.id) == itemId
              );
              if (link) {
                return {
                  item: link,
                  parent: elem,
                };
              }
            }
          }
        }

        // Search in child packages
        if (pkg.children) {
          for (const child of pkg.children) {
            const result = findItemInPackage(child, itemId, itemType);
            if (result) return result;
          }
        }

        return null;
      }

      // Context Menu Functions
      function handlePackageContextMenu(event) {
        event.preventDefault();
        event.stopPropagation();

        // Find the closest element with data-type attribute
        let element = event.target;
        while (element && !element.getAttribute("data-type")) {
          element = element.parentElement;
        }

        if (!element) return;

        const type = element.getAttribute("data-type");

        // Only show context menu for packages
        if (type === "package") {
          showContextMenu(event.clientX, event.clientY, element);
        }
      }

      function initContextMenu() {
        const contextMenu = document.getElementById("context-menu");

        if (!contextMenu) {
          console.error("Context menu element not found");
          return;
        }

        // Handle clicks anywhere on document
        const handleDocumentClick = (e) => {
          // Check if menu is visible
          if (!contextMenu.classList.contains("show")) return;

          // If click is inside menu item, let it process and close after
          if (e.target.classList.contains("context-menu-item")) {
            // Menu will be closed by handleContextMenuAction
            return;
          }

          // Otherwise close immediately
          hideContextMenu();
        };

        // Use capture phase to catch events early
        document.addEventListener("click", handleDocumentClick, true);

        // Close on scroll
        window.addEventListener(
          "scroll",
          () => {
            if (contextMenu.classList.contains("show")) {
              hideContextMenu();
            }
          },
          true
        );

        // Close on Escape key
        document.addEventListener("keydown", (e) => {
          if (e.key === "Escape" || e.key === "Esc") {
            // Close context menu if visible
            if (contextMenu.classList.contains("show")) {
              hideContextMenu();
              e.preventDefault();
            }
            // Close diagram modal if visible
            const diagramodal = document.getElementById("new-diagram-modal");
            if (diagramodal && diagramodal.classList.contains("active")) {
              closeModal("new-diagram-modal");
              e.preventDefault();
            }
          }
        });

        // Close on right click elsewhere
        document.addEventListener(
          "contextmenu",
          (e) => {
            if (
              contextMenu.classList.contains("show") &&
              !e.target.closest(".tree-structure-name")
            ) {
              hideContextMenu();
            }
          },
          true
        );
      }

      function showContextMenu(x, y, element) {
        const contextMenu = document.getElementById("context-menu");
        contextMenuTarget = element;

        // Position the menu
        contextMenu.style.left = x + "px";
        contextMenu.style.top = y + "px";
        contextMenu.classList.add("show");

        // Adjust if menu goes off screen
        const rect = contextMenu.getBoundingClientRect();
        if (rect.right > window.innerWidth) {
          contextMenu.style.left = x - rect.width + "px";
        }
        if (rect.bottom > window.innerHeight) {
          contextMenu.style.top = y - rect.height + "px";
        }
      }

      function hideContextMenu() {
        const contextMenu = document.getElementById("context-menu");
        contextMenu.classList.remove("show");
        contextMenuTarget = null;
      }

      function handleContextMenuAction(action) {
        if (!contextMenuTarget) {
          hideContextMenu();
          return;
        }

        const packageId = contextMenuTarget.getAttribute("data-id");
        let packageName = contextMenuTarget.textContent.trim();
        // Remove emoji icons from the name
        packageName = packageName.replace(/^[üì¶üìÅüóÇÔ∏è]\s*/, "");
        const modelId = contextMenuTarget.getAttribute("data-model-id");
        const profileId = contextMenuTarget.getAttribute("data-profile-id");

        // Store context for later use
        window.currentPackageContext = {
          packageId,
          packageName,
          modelId,
          profileId,
        };

        // Hide menu after getting all the data
        hideContextMenu();

        switch (action) {
          case "add-package":
            alert(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–∞ –≤ "${packageName}"\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`);
            break;
          case "add-class":
            alert(`–î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∫–ª–∞—Å—Å–∞ –≤ "${packageName}"\n–§—É–Ω–∫—Ü–∏—è –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ`);
            break;
          case "add-diagram":
            openModal("new-diagram-modal");
            break;
        }
      }

      function createDiagram() {
        const nameInput = document.getElementById("diagram-name");
        const errorDiv = document.getElementById("diagram-name-error");
        const diagramName = nameInput.value.trim();

        // Validate input
        if (!diagramName) {
          errorDiv.style.display = "block";
          nameInput.focus();
          return;
        }

        // Hide error if shown
        errorDiv.style.display = "none";

        // Get package context
        const context = window.currentPackageContext;

        if (!context) {
          alert("–û—à–∏–±–∫–∞: –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–∞–∫–µ—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }

        // Find the package and add diagram
        const projectId = getCurrentProjectId();
        const project = getProject(projectId);

        if (!project) {
          alert("–û—à–∏–±–∫–∞: –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
          return;
        }

        // Find the package in model or profile
        let packageFound = false;

        if (context.modelId) {
          const model = project.models.find((m) => m.id == context.modelId);
          if (model && model.rootPackages) {
            packageFound = addDiagramToPackage(
              model.rootPackages,
              context.packageId,
              diagramName
            );
          }
        } else if (context.profileId) {
          const profile = project.profiles.find(
            (p) => p.id == context.profileId
          );
          if (profile && profile.rootPackages) {
            packageFound = addDiagramToPackage(
              profile.rootPackages,
              context.packageId,
              diagramName
            );
          }
        }

        if (packageFound) {
          // Close modal and clear input
          closeModal("new-diagram-modal");
          nameInput.value = "";

          // Refresh tree
          renderCurrentProjectStructure();

          alert(
            `–î–∏–∞–≥—Ä–∞–º–º–∞ "${diagramName}" —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –≤ –ø–∞–∫–µ—Ç–µ "${context.packageName}"`
          );
        } else {
          alert("–û—à–∏–±–∫–∞: –ø–∞–∫–µ—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω");
        }
      }

      function addDiagramToPackage(packages, packageId, diagramName) {
        for (const pkg of packages) {
          if (pkg.id == packageId) {
            // Initialize diagrams array if not exists
            if (!pkg.diagrams) {
              pkg.diagrams = [];
            }

            // Create new diagram
            const newDiagram = {
              id: Date.now(),
              name: diagramName,
              type: "ClassDiagram",
              createdAt: new Date().toISOString(),
            };

            pkg.diagrams.push(newDiagram);
            return true;
          }

          // Search in child packages
          if (pkg.children && pkg.children.length > 0) {
            if (addDiagramToPackage(pkg.children, packageId, diagramName)) {
              return true;
            }
          }
        }

        return false;
      }

      function createModel() {
        const projectId = getCurrentProjectId();
        if (!projectId) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
          return;
        }

        const name = document.getElementById("model-name").value.trim();
        if (!name) {
          alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –º–æ–¥–µ–ª–∏");
          return;
        }

        // Check if model with this name already exists
        const existingModels = getModels(projectId);
        if (
          existingModels.some(
            (m) => m.name.toLowerCase() === name.toLowerCase()
          )
        ) {
          alert('–ú–æ–¥–µ–ª—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "' + name + '" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ');
          return;
        }

        const newModel = {
          name: name,
          type: document.getElementById("model-type").value,
          description: document.getElementById("model-desc").value,
          // classes:
          //   parseInt(document.getElementById("model-classes").value) || 100,
          // attributes:
          //   parseInt(document.getElementById("model-attributes").value) || 500,
          packages: [],
        };

        addModel(projectId, newModel);
        closeModal("new-model-modal");

        // Clear form
        document.getElementById("model-name").value = "";
        document.getElementById("model-desc").value = "";
        // document.getElementById("model-classes").value = "100";
        // document.getElementById("model-attributes").value = "500";

        renderModels();
        alert("–ú–æ–¥–µ–ª—å —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞!");
      }

      function createProfile() {
        const projectId = getCurrentProjectId();
        if (!projectId) {
          alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç");
          return;
        }

        const name = document.getElementById("profile-name").value.trim();
        if (!name) {
          alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è");
          return;
        }

        // Check if profile with this name already exists
        const existingProfiles = getProfiles(projectId);
        if (
          existingProfiles.some(
            (p) => p.name.toLowerCase() === name.toLowerCase()
          )
        ) {
          alert('–ü—Ä–æ—Ñ–∏–ª—å —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º "' + name + '" —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ –ø—Ä–æ–µ–∫—Ç–µ');
          return;
        }

        const newProfile = {
          name: name,
          description: document.getElementById("profile-desc").value,
          version: document.getElementById("profile-version").value,
        };

        addProfile(projectId, newProfile);
        closeModal("new-profile-modal");

        // Clear form
        document.getElementById("profile-name").value = "";
        document.getElementById("profile-desc").value = "";
        document.getElementById("profile-version").value = "1.0";

        renderProfiles();
        renderCurrentProjectStructure();
        alert("–ü—Ä–æ—Ñ–∏–ª—å —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!");
      }
    </script>
  </body>
</html>
